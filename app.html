<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Romaneio ‚Ä¢ Painel</title>
<meta name="theme-color" content="#0d1117"/>
<link rel="icon" href="icon-192.png"/>
<style>
:root{
  --bg:#0d1117;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
  --primary:#2563eb;--border:#1f2a44;--danger:#ef4444;--ok:#22c55e;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
header{padding:.75rem;background:#0b0f1a;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center}
header .title{font-weight:600}
nav a{margin-left:14px;color:var(--muted);text-decoration:none;font-weight:500}
nav a[hidden]{display:none}
nav a.active{color:#fff}
nav a:hover{color:var(--primary)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
h2{margin:8px 0 12px;border-bottom:1px solid var(--border);padding-bottom:6px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px}
.row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.row-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.row-1{display:grid;grid-template-columns:1fr;gap:12px}
label{font-size:12px;opacity:.8;display:block;margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:#0b1324;color:var(--text)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:.6rem .75rem;border-bottom:1px solid var(--border);text-align:left}
th{background:#111827}
.btn{padding:.55rem 1rem;background:var(--primary);border:0;border-radius:8px;color:#fff;cursor:pointer;font-weight:600}
.btn:hover{filter:brightness(1.05)}
.btn.sm{padding:.4rem .7rem;font-size:.9rem}
.btn.gray{background:#1f2937}
.btn.danger{background:var(--danger)}
.badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid var(--border);color:#9fb4ff}
.alert{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
  background:#111827;border:1px solid var(--border);padding:.6rem 1rem;border-radius:8px}
.alert.ok{border-color:#124b2e;color:#8ff0b7}
.alert.err{border-color:#4b1212;color:#ff9a9a}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
.modal .box{width:min(720px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
.chk-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
hr.sep{border:none;border-top:1px solid var(--border);margin:8px 0 12px}
</style>
</head>
<body>
<header>
  <div class="title">üöö Romaneio</div>
  <nav>
    <a id="nav-send" href="#send">Enviar Romaneio</a>
    <a id="nav-roms" href="#roms">Romaneios</a>
    <a id="nav-clients" href="#clients">Clientes</a>
    <a id="nav-fin" href="#fin">Financeiro</a>
    <a id="nav-users" href="#users">Usu√°rios</a>
    <a href="#" onclick="logout()">Sair</a>
  </nav>
</header>

<main class="wrap">

  <!-- Enviar Romaneio (sua tela j√° conhecida; resumida aqui para exemplo) -->
  <section id="tab-send" class="card" hidden>
    <h2>Enviar Romaneio</h2>
    <div class="row">
      <div><label>ROM</label><input id="rom_rom" type="number" placeholder="Ex: 21"></div>
      <div><label>Data</label><input id="rom_data" type="date"></div>
      <div><label>Observa√ß√µes</label><input id="rom_obs" placeholder="Ex.: Agendar com o cliente"></div>
    </div>
    <h3>Cliente</h3>
    <div class="row">
      <div><label>Telefone</label><input id="cli_tel" placeholder="(DDD) 90000-0000"></div>
      <div><label>Nome</label><input id="cli_nome" placeholder="Nome do cliente"></div>
      <div><label>Cidade/UF</label><input id="cli_loc" placeholder="Fortaleza/CE"></div>
    </div>
    <h3>Fornecedor <span class="badge">Opcional</span></h3>
    <div class="row">
      <div><label>Telefone</label><input id="for_tel" placeholder="(DDD) 90000-0000"></div>
      <div><label>Nome</label><input id="for_nome" placeholder="Nome do fornecedor"></div>
      <div><label>Cidade/UF</label><input id="for_loc" placeholder="Cidade-UF"></div>
    </div>
    <h3>Itens</h3>
    <table id="tblItens"><thead><tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
    <div style="margin:8px 0">
      <button class="btn sm gray" onclick="addItemRow()">+ Item</button>
      &nbsp; Total: <b id="rom_total">0</b>
    </div>
    <h3>Fotos</h3>
    <input id="rom_fotos" type="file" accept="image/*" multiple capture="environment">
    <hr class="sep"/>
    <button class="btn" onclick="enviarRomaneio()">Enviar Romaneio</button>
    <div id="rom_result" style="margin-top:10px"></div>
  </section>

  <!-- Usu√°rios -->
  <section id="tab-users" class="card" hidden>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Usu√°rios</h2>
      <button class="btn" onclick="openUserModal()">+ Novo usu√°rio</button>
    </div>
    <table id="tblUsers">
      <thead><tr><th>Usu√°rio</th><th>Nome</th><th>Ativo</th><th>Permiss√µes</th><th style="width:160px">A√ß√µes</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- (demais abas, se quiser, voc√™ adiciona depois) -->

</main>

<!-- Modal usu√°rio -->
<div class="modal" id="userModal">
  <div class="box">
    <h3 id="umTitle">Novo usu√°rio</h3>
    <div class="row-2">
      <div><label>Usu√°rio (login)</label><input id="um_usuario" placeholder="ex.: joao"/></div>
      <div><label>Nome</label><input id="um_nome" placeholder="Jo√£o Silva"/></div>
    </div>
    <div class="row-2" style="margin-top:8px">
      <div><label>Nova senha</label><input id="um_pwd1" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
      <div><label>Repita a senha</label><input id="um_pwd2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    </div>
    <div style="margin-top:8px">
      <label><input type="checkbox" id="um_ativo" checked/> Ativo</label>
    </div>
    <hr class="sep"/>
    <div>
      <label>Permiss√µes</label>
      <div class="chk-grid" id="um_perms">
        <label><input type="checkbox" value="rom:send"> Enviar romaneio</label>
        <label><input type="checkbox" value="rom:view"> Ver romaneios</label>
        <label><input type="checkbox" value="clients:view"> Ver clientes</label>
        <label><input type="checkbox" value="finance:view"> Ver financeiro</label>
        <label><input type="checkbox" value="users:view"> Ver usu√°rios</label>
        <label><input type="checkbox" value="users:edit"> Editar usu√°rios</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn gray" onclick="closeUserModal()">Cancelar</button>
      <button class="btn" onclick="saveUser()">Salvar</button>
    </div>
  </div>
</div>

<div id="toast" class="alert" style="display:none"></div>

<script>
// ======= CONFIG ‚Äì TROQUE AQUI! =======
const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec";

// ======= helpers UI =======
const $ = sel => document.querySelector(sel);
function toast(msg, type="ok"){ const el=$("#toast"); el.textContent=msg; el.className="alert "+(type==="ok"?"ok":"err"); el.style.display="block"; setTimeout(()=>el.style.display="none", 3000); }
function showTab(id){
  document.querySelectorAll("main > section").forEach(s=>s.hidden=true);
  const section = $("#tab-"+id);
  if (section) section.hidden=false;
  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  const nav = document.querySelector(nav a[href="#${id}"]);
  if (nav) nav.classList.add("active");
  history.replaceState({}, "", "#"+id);
}
function guardTabsByPerms(perms){
  const can = p => (perms.includes("*") || perms.includes(p));
  $("#nav-send").hidden   = !(can("rom:send"));
  $("#nav-roms").hidden   = !(can("rom:view") || can("rom:send"));
  $("#nav-clients").hidden= !(can("clients:view"));
  $("#nav-fin").hidden    = !(can("finance:view"));
  $("#nav-users").hidden  = !(can("users:view"));
  // Se hash atual n√£o for permitido, manda para a primeira permitida
  const preferred = ["send","roms","clients","fin","users"].find(h=>{
    const map = {send:"rom:send", roms:"rom:view", clients:"clients:view", fin:"finance:view", users:"users:view"};
    return can(map[h]) || (h==="roms" && can("rom:send"));
  });
  const current = (location.hash||"#send").slice(1);
  if (!document.querySelector(#nav-${current}) || document.querySelector(#nav-${current}).hidden){
    showTab(preferred || "send");
  } else {
    showTab(current);
  }
}

// ======= API =======
async function api(path, body={}){
  const session = JSON.parse(localStorage.getItem("session")||"null");
  const res = await fetch(API_BASE+"?path="+encodeURIComponent(path),{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify({...body, token: session?.token}),
    cache:"no-store"
  });
  if (!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}
async function whoami(){
  return api("/whoami").catch(()=>({session:null}));
}

// ======= logout + limpar cache =======
async function logout(){
  try{ await api("/logout"); }catch(_){}
  localStorage.removeItem("session");
  if (window.caches){
    const keys = await caches.keys(); for (const k of keys) await caches.delete(k);
  }
  location.href="index.html";
}

// ======= boot =======
let ME = null;
(async function boot(){
  const w = await whoami();
  if (!w.session){ location.href="index.html"; return; }
  ME = w.session;
  guardTabsByPerms(ME.perms||[]);
  // default: preparar tela de envio (adiciona 1 linha vazia)
  addItemRow();
  refreshUsersIfAllowed();
})();

// ======= Itens (envio romaneio) =======
function addItemRow(){
  const tb = $("#tblItens tbody");
  if (!tb) return;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><select class="tipo"><option value="caixa">Caixa</option><option value="saco">Saco</option></select></td>
    <td><select class="tam"><option value="p">P</option><option value="m">M</option><option value="g">G</option></select></td>
    <td><input type="number" class="qtd" min="0" value="1" style="width:100px"></td>
    <td><button class="btn sm gray" onclick="this.closest('tr').remove(); calcTotal()">Remover</button></td>`;
  tb.appendChild(tr);
  calcTotal();
}
function calcTotal(){
  let tot=0; document.querySelectorAll("#tblItens .qtd").forEach(i=> tot += Number(i.value||0));
  $("#rom_total").textContent = tot;
}
document.addEventListener("input",e=>{ if (e.target.classList.contains("qtd")) calcTotal(); });

function filesToBase64(input){
  const files = Array.from(input.files||[]);
  return Promise.all(files.map(f=>new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res({name:f.name, data:r.result}); r.readAsDataURL(f);
  })));
}

async function enviarRomaneio(){
  try{
    $("#rom_result").textContent = "Enviando‚Ä¶";
    const itens = Array.from(document.querySelectorAll("#tblItens tbody tr")).map(tr=>({
      tipo: tr.querySelector(".tipo").value,
      tamanho: tr.querySelector(".tam").value,
      qtd: Number(tr.querySelector(".qtd").value||0)
    })).filter(i=>i.qtd>0);
    const fotos = await filesToBase64($("#rom_fotos"));

    const body = {
      rom: $("#rom_rom").value, data: $("#rom_data").value, obs: $("#rom_obs").value,
      cliente: { tel: $("#cli_tel").value, nome: $("#cli_nome").value, local: $("#cli_loc").value },
      fornecedor: { tel: $("#for_tel").value, nome: $("#for_nome").value, local: $("#for_loc").value },
      itens, fotos
    };
    const r = await api("/rom/create", body);
    if (r.error) throw new Error(r.error);
    $("#rom_result").innerHTML = `
      <div class="badge">Romaneio criado!</div><br/>
      C√≥digo: <b>${r.cod}</b> ‚Äî <a target="_blank" href="${r.pdfUrl}">Abrir PDF</a> ‚Äî 
      <a target="_blank" href="${r.whatsappUrl}">WhatsApp do cliente</a>
    `;
    // limpar formul√°rio
    ["rom_rom","rom_data","rom_obs","cli_tel","cli_nome","cli_loc","for_tel","for_nome","for_loc"].forEach(id=>$("#"+id).value="");
    $("#tblItens tbody").innerHTML=""; addItemRow(); $("#rom_fotos").value="";
    toast("Romaneio enviado!", "ok");
  }catch(err){
    $("#rom_result").textContent = "Erro: "+err.message;
    toast(err.message,"err");
  }
}

// ======= Usu√°rios (UI) =======
let EDIT_USER = null; // null = novo

function permsFromUI(){
  return Array.from(document.querySelectorAll("#um_perms input:checked")).map(i=>i.value);
}
function setPermsUI(perms){
  document.querySelectorAll("#um_perms input").forEach(cb=>{
    cb.checked = (perms?.includes("*") || perms?.includes(cb.value));
  });
}
function openUserModal(u){
  EDIT_USER = u || null;
  $("#umTitle").textContent = EDIT_USER ? "Editar usu√°rio" : "Novo usu√°rio";
  $("#um_usuario").value = EDIT_USER?.usuario || "";
  $("#um_usuario").disabled = !!EDIT_USER;
  $("#um_nome").value = EDIT_USER?.nome || "";
  $("#um_pwd1").value = ""; $("#um_pwd2").value = "";
  $("#um_ativo").checked = (EDIT_USER?.ativo ?? true);
  setPermsUI(EDIT_USER?.perms || []);
  $("#userModal").style.display="flex";
}
function closeUserModal(){ $("#userModal").style.display="none"; }

async function saveUser(){
  try{
    const usuario = $("#um_usuario").value.trim();
    const nome    = $("#um_nome").value.trim();
    const p1 = $("#um_pwd1").value, p2 = $("#um_pwd2").value;
    if (!usuario) return toast("Usu√°rio √© obrigat√≥rio","err");
    if ((p1||p2) && p1!==p2) return toast("Senhas n√£o conferem","err");
    const body = {
      usuario, nome, novaSenha: p1||"", ativo: $("#um_ativo").checked,
      perms: permsFromUI()
    };
    const r = await api("/users/save", body);
    if (r.error) throw new Error(r.error);
    closeUserModal();
    toast("Usu√°rio salvo!","ok");
    refreshUsersIfAllowed();
  }catch(err){ toast(err.message,"err"); }
}

async function deleteUser(usuario){
  if (!confirm("Excluir usu√°rio '"+usuario+"'?")) return;
  try{
    const r = await api("/users/delete",{usuario});
    if (r.error) throw new Error(r.error);
    toast("Usu√°rio exclu√≠do","ok");
    refreshUsersIfAllowed();
  }catch(err){ toast(err.message,"err"); }
}

async function refreshUsersIfAllowed(){
  if (!$("#tab-users")) return;
  // s√≥ tenta listar se a aba users estiver dispon√≠vel no menu
  if ($("#nav-users").hidden) return;
  try{
    const r = await api("/users/list");
    const tb = $("#tblUsers tbody"); tb.innerHTML="";
    (r.items||[]).forEach(u=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.usuario}</td>
        <td>${u.nome||"-"}</td>
        <td>${u.ativo? "Sim":"N√£o"}</td>
        <td>${(u.perms||[]).join(", ")||"-"}</td>
        <td>
          <button class="btn sm gray" onclick='openUserModal(${JSON.stringify(u)})'>Editar</button>
          <button class="btn sm danger" style="margin-left:6px" ${u.usuario==="admin"?"disabled":""}
            onclick="deleteUser('${u.usuario}')">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(_){/* ignorar */ }
}

// ======= Router simples das abas =======
window.addEventListener("hashchange", ()=>{
  const h = (location.hash||"#send").slice(1);
  showTab(h);
});

</script>
</body>
</html>
