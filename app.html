<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#0f172a; --bg-card:#0b1222; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#3b82f6; --primary-2:#1d4ed8; --danger:#ef4444; --ok:#22c55e;
      --border:#1f2a44; --chip:#111a31;
    }
    .light{
      --bg:#f7f7fb; --bg-card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#2563eb; --primary-2:#1e40af; --danger:#dc2626; --ok:#16a34a;
      --border:#e5e7eb; --chip:#edf2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;z-index:5;background:var(--bg);border-bottom:1px solid var(--border)}
    .nav{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 0}
    .menu{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:10px 14px;border-radius:12px;background:var(--chip);border:1px solid var(--border);cursor:pointer}
    .chip.primary{background:var(--primary);border-color:transparent;color:#fff}
    .chip.danger{background:var(--danger);color:#fff;border-color:transparent}
    .chip.ghost{background:transparent}
    .tag{font-size:12px;opacity:.8;margin-left:6px}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      background:#0b1222; color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; width:100%;
    }
    .light input,.light select,.light textarea{background:#fff}
    textarea{min-height:90px}
    .row{display:flex;gap:10px;align-items:center}
    .space{height:8px}
    .btn{padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--chip);color:var(--text);cursor:pointer}
    .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
    .btn.muted{background:transparent}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .right{display:flex;justify-content:flex-end;gap:10px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:10px 6px;text-align:left}
    .total{font-weight:600}
    .status{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg-card)}
    .status.ok{border-color:transparent;background:var(--ok);color:#fff}
    .status.err{border-color:transparent;background:var(--danger);color:#fff}
    .hidden{display:none}
    .avatar{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--chip)}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{position:relative}
    .thumb img{width:90px;height:90px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .thumb button{position:absolute;right:4px;top:4px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:8px;padding:2px 6px;cursor:pointer}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:8}
    .modal.show{display:flex}
    .receipt{max-width:520px;width:100%;background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:18px}
    .receipt h3{margin:0 0 10px}
    .kv{display:flex;justify-content:space-between;gap:14px;padding:6px 0;border-bottom:1px dashed var(--border)}
    .kv:last-child{border-bottom:none}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="row" style="gap:10px">
        <div class="chip">üöö <b>Romaneio</b> <span id="who" class="tag"></span></div>
        <div class="menu">
          <a class="chip primary" href="#rom">Enviar Romaneio</a>
          <a class="chip ghost" href="#clients">Clientes</a>
          <a class="chip ghost" href="#roms">Romaneios</a>
          <a class="chip ghost" href="#fin">Financeiro</a>
          <a class="chip ghost" id="goUsers" href="#users">Usu√°rios</a>
        </div>
      </div>
      <div class="row" style="gap:8px">
        <button id="themeBtn" class="chip">üåô/‚òÄÔ∏è</button>
        <button id="logoutBtn" class="chip danger">Sair</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="viewRom">
    <h2>Enviar Romaneio</h2>
    <div class="card">
      <div class="grid">
        <div>
          <label>ROM</label>
          <input id="rom" type="text" placeholder="Ex.: 21">
        </div>
        <div>
          <label>Data</label>
          <input id="data" type="date">
        </div>
      </div>
      <div class="space"></div>
      <div>
        <label>Observa√ß√µes</label>
        <textarea id="obs" placeholder="Ex.: Doca 3, at√© 16h"></textarea>
      </div>
    </div>

    <div class="card">
      <h3>Cliente</h3>
      <div class="grid">
        <div>
          <label>Telefone</label>
          <input id="cli_tel" placeholder="85999999999" inputmode="numeric">
        </div>
        <div>
          <label>Nome</label>
          <input id="cli_nome" placeholder="Nome do cliente">
        </div>
        <div>
          <label>Cidade/UF</label>
          <input id="cli_local" placeholder="Fortaleza/CE">
        </div>
        <div class="muted" style="display:flex;align-items:flex-end">Fornecedor opcional ‚ûú</div>
      </div>
      <div class="space"></div>
      <h3>Fornecedor</h3>
      <div class="grid">
        <div>
          <label>Telefone</label>
          <input id="for_tel" placeholder="85999999999" inputmode="numeric">
        </div>
        <div>
          <label>Nome</label>
          <input id="for_nome" placeholder="Nome do fornecedor">
        </div>
        <div>
          <label>Cidade/UF</label>
          <input id="for_local" placeholder="Maracana√∫/CE">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>Itens</h3>
        <div class="muted">Total: <span id="total">0</span></div>
      </div>
      <table class="table" id="tblItens">
        <thead>
          <tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th>A√ß√£o</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="space"></div>
      <button class="btn" id="addItem">+ Item</button>
    </div>

    <div class="card">
      <h3>Fotos</h3>
      <input id="fotoInput" type="file" accept="image/*" multiple />
      <div class="thumbs" id="thumbs"></div>
      <div class="muted" style="margin-top:8px">Voc√™ pode selecionar v√°rias imagens. Pr√©-visualiza√ß√£o acima.</div>
    </div>

    <div class="right">
      <button id="btnLimpar" class="btn muted">Limpar</button>
      <button id="btnEnviar" class="btn primary">Enviar</button>
    </div>
  </main>

  <!-- status -->
  <div id="status" class="status hidden">...</div>

  <!-- modal recibo -->
  <div id="modal" class="modal">
    <div class="receipt">
      <h3>‚úÖ Romaneio criado</h3>
      <div class="kv"><span class="muted">C√≥digo</span><b id="rc_cod">‚Äî</b></div>
      <div class="kv"><span class="muted">ROM</span><span id="rc_rom"></span></div>
      <div class="kv"><span class="muted">Cliente</span><span id="rc_cli"></span></div>
      <div class="kv"><span class="muted">Fornecedor</span><span id="rc_for"></span></div>
      <div class="kv"><span class="muted">Total</span><span id="rc_total"></span></div>
      <div class="space"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <a class="btn" id="rc_pdf" target="_blank">Abrir PDF</a>
        <a class="btn" id="rc_wa" target="_blank">WhatsApp</a>
        <button class="btn" id="rc_copy">Copiar c√≥digo</button>
        <button class="btn danger" id="rc_close">Fechar</button>
      </div>
    </div>
  </div>

  <script>
  // ========= CONFIG =========
  const API_BASE = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLj1he6pEbcg2BYwJJotAEvhpzl5YZsnQxW8BfPXrcje0CxInM7VSp-qK7VEdwzDiSSXEIShjP-tonbqbFx7RzgBu_UCmzjeprZ_MYo3xo4efKcUPZdZcyYbYRcrIJGwAgAach_q9_tF5RzbwA3lWkJQXbYsI7V5FbImQHhPd7GVwAKhRPzhs45AfmXK0GuBaNUZrowWYwbVVAwW-XSkqdizQArbCFh-qiW_0qVGzIx4xbDE0iL4NKWi3laib5l7pVqV8OT-wWV9J8EC8tsWvFdgdrGPKg&lib=MgCquoYzRceSzn8l97_yAGg5THVlN2byw"; // <- SEU /exec

  // ========= TEMA =========
  const root = document.documentElement;
  function applyTheme(){
    const t = localStorage.getItem("theme") || "dark";
    if(t === "light") root.classList.add("light"); else root.classList.remove("light");
  }
  applyTheme();
  document.getElementById("themeBtn").onclick = ()=>{
    const cur = localStorage.getItem("theme") || "dark";
    localStorage.setItem("theme", cur==="dark" ? "light" : "dark");
    applyTheme();
  };

  // ========= SESS√ÉO / GUARDA =========
  const sess = JSON.parse(localStorage.getItem("sess") || "null");
  const who = document.getElementById("who");
  if(!sess || !sess.token){
    // guarda simples sem loop
    window.location.href = "./index.html";
  }else{
    who.textContent = sess.usuario ? ` ${sess.usuario}` : "";
  }
  document.getElementById("logoutBtn").onclick = async ()=>{
    try{ await post("/logout", {}); }catch(_){}
    localStorage.removeItem("sess");
    window.location.href = "./index.html";
  };

  // ========= HELPERS =========
  function showStatus(msg, kind=""){
    const el = document.getElementById("status");
    el.textContent = msg;
    el.classList.remove("hidden","ok","err");
    if(kind==="ok") el.classList.add("ok");
    if(kind==="err") el.classList.add("err");
    setTimeout(()=>el.classList.add("hidden"), 3500);
  }
  function todayISO(){
    const d = new Date();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dy = String(d.getDate()).padStart(2,"0");
    return `${d.getFullYear()}-${m}-${dy}`;
  }

  async function post(path, body){
    const r = await fetch(`${API_BASE}?path=${encodeURIComponent(path)}`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ ...(body||{}), token: sess?.token || "" })
    });
    // Apps Script sempre responde 200; checamos JSON
    return await r.json();
  }

  // ========= FORM DOM =========
  const $ = (id)=>document.getElementById(id);
  $("data").value = todayISO();

  // Itens (linhas)
  const tbody = $("tblItens").querySelector("tbody");
  function recalc(){
    let tot = 0;
    tbody.querySelectorAll("tr").forEach(tr=>{
      const q = Number(tr.querySelector('input[type="number"]').value||0);
      tot += q;
    });
    $("total").textContent = tot;
  }
  function addRow(tipo="Caixa", tam="P", qtd=1){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <select>
          <option${tipo==="Caixa"?" selected":""}>Caixa</option>
          <option${tipo==="Saco"?" selected":""}>Saco</option>
        </select>
      </td>
      <td>
        <select>
          <option${tam==="P"?" selected":""}>P</option>
          <option${tam==="M"?" selected":""}>M</option>
          <option${tam==="G"?" selected":""}>G</option>
        </select>
      </td>
      <td><input type="number" min="1" value="${qtd}"></td>
      <td><button class="btn danger btnDel">Remover</button></td>
    `;
    tr.querySelector('input[type="number"]').addEventListener("input", recalc);
    tr.querySelector(".btnDel").onclick = ()=>{ tr.remove(); recalc(); };
    tbody.appendChild(tr);
    recalc();
  }
  $("addItem").onclick = ()=> addRow();
  // come√ßa com 1 linha
  addRow();

  // Fotos (pr√©-visualiza√ß√£o)
  let fotos = []; // {file, dataUrl}
  async function fileToDataURL(file){
    return new Promise((res,rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }
  function renderThumbs(){
    const c = $("thumbs"); c.innerHTML = "";
    fotos.forEach((f,i)=>{
      const d = document.createElement("div");
      d.className = "thumb";
      d.innerHTML = `<img src="${f.dataUrl}"><button title="Remover">‚úï</button>`;
      d.querySelector("button").onclick = ()=>{ fotos.splice(i,1); renderThumbs(); };
      c.appendChild(d);
    });
  }
  $("fotoInput").addEventListener("change", async (ev)=>{
    const files = Array.from(ev.target.files||[]);
    for(const file of files){
      const dataUrl = await fileToDataURL(file);
      fotos.push({ file, dataUrl });
    }
    renderThumbs();
    // limpa o input para permitir escolher o mesmo arquivo de novo
    ev.target.value = "";
  });

  // Limpar formul√°rio
  $("btnLimpar").onclick = ()=>{
    $("rom").value = "";
    $("data").value = todayISO();
    $("obs").value = "";
    $("cli_tel").value = "";
    $("cli_nome").value = "";
    $("cli_local").value = "";
    $("for_tel").value = "";
    $("for_nome").value = "";
    $("for_local").value = "";
    tbody.innerHTML = "";
    addRow();
    fotos = [];
    renderThumbs();
    showStatus("Formul√°rio limpo");
  };

  // Enviar
  $("btnEnviar").onclick = async ()=>{
    try{
      const rom = $("rom").value.trim();
      const data = $("data").value;
      const obs  = $("obs").value.trim();
      const cliente = { tel:$("cli_tel").value.trim(), nome:$("cli_nome").value.trim(), local:$("cli_local").value.trim() };
      const fornecedor = { tel:$("for_tel").value.trim(), nome:$("for_nome").value.trim(), local:$("for_local").value.trim() };

      const itens = [];
      tbody.querySelectorAll("tr").forEach(tr=>{
        const tipo = tr.children[0].querySelector("select").value;
        const tamanho = tr.children[1].querySelector("select").value;
        const qtd = Number(tr.children[2].querySelector('input[type="number"]').value||0);
        if(qtd>0) itens.push({ tipo, tamanho, qtd });
      });
      if(!itens.length){ showStatus("Adicione ao menos 1 item", "err"); return; }

      // prepara fotos (base64)
      const fotosPayload = fotos.map(f=>({ name:f.file?.name||"foto.jpg", data:f.dataUrl }));

      showStatus("Enviando‚Ä¶");
      const rsp = await post("/rom/create", { rom, data, obs, cliente, fornecedor, itens, fotos:fotosPayload });
      if(rsp.error){ showStatus(rsp.error, "err"); return; }

      // sucesso
      showStatus("Romaneio criado!", "ok");

      // Zera o form
      $("btnLimpar").click();

      // abre modal recibo
      $("rc_cod").textContent   = rsp.cod;
      $("rc_rom").textContent   = rom || "‚Äî";
      $("rc_cli").textContent   = `${cliente.nome || "‚Äî"} (${cliente.tel || "‚Äî"})`;
      $("rc_for").textContent   = `${fornecedor.nome || "‚Äî"} (${fornecedor.tel || "‚Äî"})`;
      $("rc_total").textContent = (itens.reduce((s,i)=>s+Number(i.qtd||0),0)).toString();
      $("rc_pdf").href = rsp.pdfUrl || "#";
      $("rc_wa").href  = rsp.whatsappUrl || "#";
      $("modal").classList.add("show");

    }catch(err){
      console.error(err);
      showStatus("Falha: " + (err?.message||err), "err");
    }
  };

  $("rc_close").onclick = ()=> $("modal").classList.remove("show");
  $("rc_copy").onclick  = async ()=>{
    const code = $("rc_cod").textContent;
    try{ await navigator.clipboard.writeText(code); showStatus("C√≥digo copiado", "ok"); }
    catch(_){ showStatus("N√£o foi poss√≠vel copiar", "err"); }
  };

  // ======== ROTEAMENTO TRIVIAL (mant√©m menu ‚Äúativo‚Äù) ========
  function markMenu(){
    const h = (location.hash||"#rom");
    document.querySelectorAll("header .menu a").forEach(a=>{
      a.classList.toggle("primary", a.getAttribute("href")===h);
      a.classList.toggle("ghost", a.getAttribute("href")!==h);
    });
  }
  window.addEventListener("hashchange", markMenu);
  markMenu();

  // ======== DIAGN√ìSTICO R√ÅPIDO (opcional, comente se quiser) ========
  (async()=>{
    try{
      const pong = await post("/ping",{});
      if(!pong || !pong.pong) console.warn("Ping sem sucesso", pong);
    }catch(e){
      console.warn("Ping falhou", e);
    }
  })();
  </script>
</body>
</html>
