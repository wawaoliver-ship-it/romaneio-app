<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio â€¢ Painel</title>
  <meta name="theme-color" content="#0d1117" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0d1117;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
      --primary:#2563eb;--border:#1f2a44;
    }
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:.75rem;background:#0b0f1a;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center}
    header .title{font-weight:600}
    nav a{margin-left:14px;color:var(--muted);text-decoration:none;font-weight:500}
    nav a:hover{color:var(--primary)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h2{margin-top:28px;border-bottom:1px solid var(--border);padding-bottom:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:.6rem .75rem;border-bottom:1px solid var(--border);text-align:left}
    th{background:#111827}
    .btn{padding:.5rem 1rem;background:var(--primary);border:0;
      border-radius:6px;color:#fff;cursor:pointer;font-weight:600}
    .btn:hover{background:#1d4ed8}
  </style>
</head>
<body>
  <header>
    <div class="title">ðŸšš Romaneio</div>
    <nav>
      <a href="#" onclick="showTab('clientes')">Clientes</a>
      <a href="#" onclick="showTab('romaneios')">Romaneios</a>
      <a href="#" onclick="showTab('financeiro')">Financeiro</a>
      <a href="#" onclick="logout()">Sair</a>
    </nav>
  </header>

  <main class="wrap">
    <section id="clientes" class="tab">
      <h2>Clientes</h2>
      <button class="btn" onclick="carregarClientes()">ðŸ”„ Atualizar</button>
      <table id="tblClientes">
        <thead><tr><th>Nome</th><th>Telefone</th><th>Email</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="romaneios" class="tab" style="display:none">
      <h2>Romaneios</h2>
      <button class="btn" onclick="carregarRomaneios()">ðŸ”„ Atualizar</button>
      <table id="tblRomaneios">
        <thead><tr><th>ID</th><th>Data</th><th>Cliente</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="financeiro" class="tab" style="display:none">
      <h2>Financeiro</h2>
      <button class="btn" onclick="carregarFinanceiro()">ðŸ”„ Atualizar</button>
      <table id="tblFinanceiro">
        <thead><tr><th>ID</th><th>Data</th><th>DescriÃ§Ã£o</th><th>Valor</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
  // === TROQUE AQUI PELO SEU /exec ===
  const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec";

async function api(path, body = {}, token = null) {
  const session = JSON.parse(localStorage.getItem("session")||"null");
  const url = API_BASE + "?path=" + encodeURIComponent(path);
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify({...body, token: session?.token}),
    cache: "no-store"
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

  async function carregarClientes(){
    const data = await api("/clientes");
    const tbody = document.querySelector("#tblClientes tbody");
    tbody.innerHTML = "";
    (data.items||[]).forEach(c=>{
      tbody.innerHTML += `<tr><td>${c.nome}</td><td>${c.fone||""}</td><td>${c.email||""}</td></tr>`;
    });
  }

  async function carregarRomaneios(){
    const data = await api("/romaneios");
    const tbody = document.querySelector("#tblRomaneios tbody");
    tbody.innerHTML = "";
    (data.items||[]).forEach(r=>{
      tbody.innerHTML += `<tr><td>${r.id}</td><td>${r.data}</td><td>${r.cliente}</td><td>${r.status}</td></tr>`;
    });
  }

  async function carregarFinanceiro(){
    const data = await api("/financeiro");
    const tbody = document.querySelector("#tblFinanceiro tbody");
    tbody.innerHTML = "";
    (data.items||[]).forEach(f=>{
      tbody.innerHTML += `<tr><td>${f.id}</td><td>${f.data}</td><td>${f.desc}</td><td>${f.valor}</td></tr>`;
    });
  }

  function logout(){
    localStorage.removeItem("session");
    location.href="index.html";
  }

  // carrega tab padrÃ£o
  showTab("clientes");
</script>
</body>
</html>
<!-- ===================== ROMANEIO â€“ FORM ===================== -->
<section id="rom-form" style="padding:16px;">
  <h2>Romaneio</h2>

  <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;max-width:920px">
    <label>ROM
      <input id="rom_rom" type="number" style="width:100%;padding:8px">
    </label>
    <label>Data
      <input id="rom_data" type="date" style="width:100%;padding:8px">
    </label>
    <label>OBS
      <textarea id="rom_obs" rows="2" style="width:100%;padding:8px" placeholder="ObservaÃ§Ãµes"></textarea>
    </label>
  </div>

  <h3 style="margin-top:16px">Cliente</h3>
  <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;max-width:920px">
    <label>Telefone
      <input id="cli_tel" style="width:100%;padding:8px" placeholder="ex: 81999999999">
    </label>
    <label>Nome
      <input id="cli_nome" style="width:100%;padding:8px">
    </label>
    <label>Cidade/UF
      <input id="cli_loc" style="width:100%;padding:8px" placeholder="Recife/PE">
    </label>
  </div>

  <h3 style="margin-top:16px">Fornecedor</h3>
  <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;max-width:920px">
    <label>Telefone
      <input id="for_tel" style="width:100%;padding:8px">
    </label>
    <label>Nome
      <input id="for_nome" style="width:100%;padding:8px">
    </label>
    <label>Cidade/UF
      <input id="for_loc" style="width:100%;padding:8px">
    </label>
  </div>

  <h3 style="margin-top:16px">Itens</h3>
  <table id="tblItens" style="width:100%;max-width:920px;border-collapse:collapse">
    <thead>
      <tr>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd">Tipo</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd">Tamanho</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid #ddd">Qtd</th>
        <th style="padding:6px;border-bottom:1px solid #ddd"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button type="button" onclick="addItemRow()" style="margin-top:8px;padding:8px 12px">+ Item</button>
  <div class="total" style="margin-top:8px"><b>Total:</b> <span id="rom_total">0</span></div>

  <h3 style="margin-top:16px">Fotos</h3>
  <input id="rom_fotos" type="file" accept="image/*" multiple capture="environment">
  <div style="margin-top:6px;font-size:12px;color:#666">As fotos serÃ£o salvas no Drive e vinculadas ao cÃ³digo gerado.</div>

  <div style="margin-top:18px">
    <button onclick="enviarRomaneio()" style="padding:10px 16px">Enviar Romaneio</button>
  </div>

  <div id="rom_result" style="margin-top:12px"></div>
</section>

<script>
const $ = (sel)=>document.querySelector(sel);
function sess(){ try { return JSON.parse(localStorage.getItem("session"))||null; } catch(_) { return null; } }

function addItemRow(){
  const tb = $("#tblItens tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td style="padding:6px">
      <select class="tipo" style="padding:6px;width:120px">
        <option value="caixa">Caixa</option>
        <option value="saco">Saco</option>
      </select>
    </td>
    <td style="padding:6px">
      <select class="tam" style="padding:6px;width:90px">
        <option value="p">P</option>
        <option value="m">M</option>
        <option value="g">G</option>
      </select>
    </td>
    <td style="padding:6px">
      <input type="number" min="0" class="qtd" value="0" style="padding:6px;width:100px">
    </td>
    <td style="padding:6px"><button type="button" onclick="this.closest('tr').remove(); calcTotal()">x</button></td>
  `;
  tb.appendChild(tr);
}
function calcTotal(){
  let tot=0;
  document.querySelectorAll("#tblItens .qtd").forEach(i=> tot += Number(i.value||0));
  $("#rom_total").textContent = tot;
}
document.addEventListener("input", (e)=>{ if (e.target.classList.contains("qtd")) calcTotal(); });

function filesToBase64(input){
  const files = Array.from(input.files||[]);
  return Promise.all(files.map(f => new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res({ name:f.name, data:r.result });
    r.readAsDataURL(f);
  })));
}

async function enviarRomaneio(){
  try{
    const itens = Array.from(document.querySelectorAll("#tblItens tbody tr")).map(tr=>({
      tipo: tr.querySelector(".tipo").value,
      tamanho: tr.querySelector(".tam").value,
      qtd: Number(tr.querySelector(".qtd").value||0)
    })).filter(i=>i.qtd>0);

    const fotos = await filesToBase64($("#rom_fotos"));

    const body = {
      rom: $("#rom_rom").value,
      data: $("#rom_data").value,
      obs : $("#rom_obs").value,
      cliente: { tel: $("#cli_tel").value, nome: $("#cli_nome").value, local: $("#cli_loc").value },
      fornecedor: { tel: $("#for_tel").value, nome: $("#for_nome").value, local: $("#for_loc").value },
      itens, fotos
    };

    $("#rom_result").textContent = "Enviando...";
    const s = sess();
    const r = await api("/rom/create", body, s?.token);
    if (r.error) throw new Error(r.error);

    $("#rom_result").innerHTML = `
      <div><b>Romaneio criado!</b></div>
      <div>CÃ³digo: <b>${r.cod}</b></div>
      <div><a href="${r.pdfUrl}" target="_blank">Abrir PDF</a></div>
      <div><a href="${r.whatsappUrl}" target="_blank">WhatsApp do cliente</a></div>
    `;
  }catch(err){
    $("#rom_result").textContent = "Erro: " + err.message;
  }
}

document.addEventListener("DOMContentLoaded", ()=> addItemRow());
</script>
