<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0d1117" />
<title>Romaneio ‚Ä¢ Painel</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{
  --bg:#0b0f19;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
  --primary:#2563eb;--primary-hover:#1d4ed8;--border:#1f2a44;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
header{position:sticky;top:0;background:#0d1117;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;align-items:center;z-index:5}
.brand{font-weight:700;letter-spacing:.3px;color:#9abaff}
.spacer{flex:1}
button{border:1px solid #334155;background:#0b0f19;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
button.primary{background:var(--primary);border-color:var(--primary)}
button:hover{opacity:.95}
main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
h2{margin:0 0 10px 0;font-size:18px;color:#c7d2fe}
.note{color:#9aa4b2}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;text-align:left}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0b0f19;color:#9aa4b2}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px}
.modal.show{display:flex}
.modal > .content{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:900px;width:100%;max-height:80vh;overflow:auto}
.modal h3{margin:0 0 10px 0;color:#c7d2fe}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
input,select{background:#0b0f19;border:1px solid #243146;color:var(--text);border-radius:10px;padding:10px}

/* Toast */
.toast{position:fixed;right:12px;bottom:12px;background:#0b0f19;border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none}
.toast.show{display:block}
</style>
</head>
<body>
<header>
  <div class="brand">üöö Romaneio</div>
  <div class="spacer"></div>
  <button id="btnUsers" class="ghost">Usu√°rios</button>
  <button id="btnAudit" class="ghost">Auditoria</button>
  <button id="btnPwd" class="ghost">Minha senha</button>
  <button id="btnLogout">Sair</button>
</header>

<main>
  <section class="grid">
    <div class="card">
      <h2>Novo Romaneio</h2>
      <p class="note">Em breve: formul√°rio completo com foto, volumes e impress√£o A4.</p>
      <button disabled>Em breve</button>
    </div>
    <div class="card">
      <h2>Meus Romaneios</h2>
      <p class="note">Filtro por cidade/romaneio e impress√£o. Integra√ß√£o chega no pr√≥ximo passo.</p>
      <button disabled>Em breve</button>
    </div>
    <div class="card">
      <h2>Clientes</h2>
      <p class="note">Cadastro/consulta por telefone vir√° junto do fluxo de romaneio.</p>
      <button disabled>Em breve</button>
    </div>
  </section>

  <section class="card">
    <h2>Sess√£o</h2>
    <div id="sessInfo" class="note"></div>
  </section>

  <section class="card">
    <h2>Tabela de Pre√ßos (Planilha ‚Üí ITENS)</h2>
    <table class="table" id="tblItens">
      <thead><tr><th>Embalagem</th><th>Valor</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Modal Usu√°rios -->
<div class="modal" id="mdlUsers">
  <div class="content" id="mdlUsersContent">
    <h3>Usu√°rios</h3>
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:14px">
      <div>
        <table class="table" id="tblUsers">
          <thead>
            <tr><th>Usu√°rio</th><th>Nome</th><th>Perfil</th><th>Ativo</th><th>A√ß√µes</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card" style="padding:12px">
        <h4 style="margin:0 0 8px 0">Novo usu√°rio</h4>
        <div class="field"><label>Usu√°rio</label><input id="nuUsuario" placeholder="ex.: joao" /></div>
        <div class="field"><label>Nome</label><input id="nuNome" placeholder="Jo√£o da Silva" /></div>
        <div class="field"><label>Senha</label><input id="nuSenha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        <div class="field"><label>Perfil</label>
          <select id="nuRole"><option value="admin">admin</option><option value="operador">operador</option></select>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnCreateUser" class="primary">Criar</button>
          <button id="btnCloseUsers">Fechar</button>
        </div>
        <div class="note" id="usersMsg" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Minha senha -->
<div class="modal" id="mdlPwd">
  <div class="content" id="mdlPwdContent" style="max-width:420px">
    <h3>Alterar minha senha</h3>
    <div class="field"><label>Senha atual</label><input id="pwdAtual" type="password" /></div>
    <div class="field"><label>Nova senha</label><input id="pwdNova" type="password" /></div>
    <div class="field"><label>Confirmar nova senha</label><input id="pwdConf" type="password" /></div>
    <div style="display:flex;gap:8px">
      <button id="btnSavePwd" class="primary">Salvar</button>
      <button id="btnClosePwd">Fechar</button>
    </div>
    <div class="note" id="pwdMsg" style="margin-top:6px"></div>
  </div>
</div>

<!-- Modal Auditoria -->
<div class="modal" id="mdlAudit">
  <div class="content" id="mdlAuditContent">
    <h3>Auditoria (√∫ltimos eventos)</h3>
    <table class="table" id="tblAudit">
      <thead><tr><th>Quando</th><th>Usu√°rio</th><th>Role</th><th>A√ß√£o</th><th>Detalhes</th><th>Ref</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:8px"><button id="btnCloseAudit">Fechar</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbyGZu5c4vTiXjQx5Ud45m0Ij3Dotejl_ziYTdFmjtWXU4cPRz1i2qWLPkVF4RzhuIMr/exec";
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

function saveSession(s){ localStorage.setItem("rom.session", JSON.stringify(s)); }
function getSession(){ try{return JSON.parse(localStorage.getItem("rom.session")||"null")}catch(_){return null} }
function clearSession(){ localStorage.removeItem("rom.session"); }
function toast(msg, ok=true){
  const t=$("#toast"); t.textContent=(ok?"‚úÖ ":"‚ùå ")+msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 3000);
}
async function api(path, data={}){
  const sess=getSession(); const url = API_BASE + "?path="+encodeURIComponent(path)+(sess && sess.token? "&token="+encodeURIComponent(sess.token):"");
  const res = await fetch(url,{ method:"POST", mode:"cors", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(data) });
  return await res.json();
}

async function boot(){
  // exige sess√£o v√°lida
  const sess = getSession();
  if (!sess || !sess.token){
    location.href="index.html"; return;
  }
  const r = await api("/whoami",{});
  if (!r || !r.session){ clearSession(); location.href="index.html"; return; }
  // header buttons por role
  $("#btnUsers").style.display = r.session.role==="admin"?"inline-block":"none";
  $("#btnAudit").style.display = r.session.role==="admin"?"inline-block":"none";
  $("#sessInfo").textContent = `Usu√°rio: ${r.session.usuario} ‚Ä¢ Perfil: ${r.session.role} ‚Ä¢ Token: ${r.session.token.slice(0,6)}‚Ä¶`;

  // itens
  const li = await api("/itens/list",{});
  const tbody = $("#tblItens tbody"); tbody.innerHTML="";
  (li?.itens||[]).forEach(i=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i.embalagem||""}</td><td>R$ ${Number(i.valor||0).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

$("#btnLogout").addEventListener("click", async ()=>{
  await api("/logout",{}).catch(()=>{});
  clearSession();
  location.href="index.html";
});

/* ==== Modal Usu√°rios ==== */
const mdlUsers = $("#mdlUsers");
$("#btnUsers").addEventListener("click", async ()=>{
  mdlUsers.classList.add("show");
  await loadUsers();
});
$("#btnCloseUsers").addEventListener("click", ()=> mdlUsers.classList.remove("show"));
mdlUsers.addEventListener("click", ()=> mdlUsers.classList.remove("show"));
$("#mdlUsersContent").addEventListener("click", e=> e.stopPropagation()); // n√£o fecha ao clicar dentro

async function loadUsers(){
  $("#usersMsg").textContent="";
  const r = await api("/users/list",{});
  const tbody = $("#tblUsers tbody"); tbody.innerHTML="";
  if (r?.users){
    r.users.forEach(u=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${u.usuario}</td>
        <td>${u.nome||""}</td>
        <td><span class="badge">${u.role}</span></td>
        <td>${u.ativo? "‚úÖ" : "‚ùå"}</td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">
          <button data-act="toggle" data-u="${u.usuario}" class="ghost">${u.ativo?"Desativar":"Ativar"}</button>
          <button data-act="reset" data-u="${u.usuario}" class="ghost">Resetar senha</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
}
$("#tblUsers").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const act = btn.dataset.act, usuario = btn.dataset.u;
  if (act==="toggle"){
    const want = btn.textContent.includes("Desativar") ? false : true;
    const r = await api("/users/setActive",{ usuario, ativo: want });
    if (r?.error) toast(r.error,false); else { toast("Atualizado"); loadUsers(); }
  }
  if (act==="reset"){
    const nova = prompt(`Nova senha para ${usuario}:`);
    if (!nova) return;
    const r = await api("/users/resetPassword",{ usuario, novaSenha: nova });
    if (r?.error) toast(r.error,false); else toast("Senha redefinida");
  }
});
$("#btnCreateUser").addEventListener("click", async ()=>{
  const usuario = $("#nuUsuario").value.trim();
  const nome    = $("#nuNome").value.trim();
  const senha   = $("#nuSenha").value;
  const role    = $("#nuRole").value;
  if (!usuario || !senha){ $("#usersMsg").textContent="Informe usu√°rio e senha."; return; }
  const r = await api("/users/create",{ usuario, nome, senha, role });
  if (r?.error){ $("#usersMsg").textContent = "Erro: "+r.error; return; }
  $("#usersMsg").textContent = "Criado!";
  $("#nuUsuario").value = $("#nuNome").value = $("#nuSenha").value = "";
  await loadUsers();
});

/* ==== Modal Minha Senha ==== */
const mdlPwd = $("#mdlPwd");
$("#btnPwd").addEventListener("click", ()=> mdlPwd.classList.add("show"));
$("#btnClosePwd").addEventListener("click", ()=> mdlPwd.classList.remove("show"));
mdlPwd.addEventListener("click", ()=> mdlPwd.classList.remove("show"));
$("#mdlPwdContent").addEventListener("click", e=> e.stopPropagation());

$("#btnSavePwd").addEventListener("click", async ()=>{
  $("#pwdMsg").textContent="";
  const atual=$("#pwdAtual").value, nova=$("#pwdNova").value, conf=$("#pwdConf").value;
  if (!atual || !nova || !conf) { $("#pwdMsg").textContent="Preencha todos os campos."; return; }
  if (nova!==conf){ $("#pwdMsg").textContent="As senhas n√£o conferem."; return; }
  const r = await api("/user/changePassword",{ senhaAtual:atual, novaSenha:nova });
  if (r?.error){ $("#pwdMsg").textContent="Erro: "+r.error; return; }
  $("#pwdMsg").textContent="Senha alterada!";
  $("#pwdAtual").value = $("#pwdNova").value = $("#pwdConf").value = "";
});

/* ==== Modal Auditoria (admin) ==== */
const mdlAudit = $("#mdlAudit");
$("#btnAudit").addEventListener("click", async ()=>{
  mdlAudit.classList.add("show");
  const tbody = $("#tblAudit tbody"); tbody.innerHTML="";
  const r = await api("/audit/list",{ limit: 200 });
  (r?.rows||[]).forEach(a=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${a.at||""}</td><td>${a.usuario||""}</td><td>${a.role||""}</td><td>${a.acao||""}</td><td>${a.detalhes||""}</td><td>${a.ref||""}</td>`;
    tbody.appendChild(tr);
  });
});
$("#btnCloseAudit").addEventListener("click", ()=> mdlAudit.classList.remove("show"));
mdlAudit.addEventListener("click", ()=> mdlAudit.classList.remove("show"));
$("#mdlAuditContent").addEventListener("click", e=> e.stopPropagation());

/* ==== PWA ==== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw.js").catch(()=>{}));
}

boot();
</script>
</body>
</html>
