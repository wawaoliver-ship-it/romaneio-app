<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Romaneio ‚Ä¢ Painel</title>
  <style>
    :root{
      --bg:#0b0f19;--panel:#0f172a;--muted:#8a94ae;--text:#e6edf3;
      --primary:#2563eb;--primary-hover:#1d4ed8;--border:#1f2a44;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{position:sticky;top:0;background:#0d1222;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;align-items:center;z-index:5}
    .brand{font-weight:700;letter-spacing:.3px}
    .chip{border:1px solid var(--border);padding:.35rem .6rem;border-radius:999px;background:#0b1020}
    .btn{border:1px solid var(--border);background:#0b1020;color:var(--text);padding:.55rem .9rem;border-radius:.65rem;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary)}
    .btn:hover{opacity:.92}
    main{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:1fr 1fr}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px}
    h1{margin:0 0 10px;font-size:20px}
    h2{margin:.2rem 0 .8rem;font-size:18px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left}
    .muted{color:var(--muted);font-size:.9rem}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:20}
    .modal.on{display:flex}
    .modal .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;max-width:900px;width:96%;padding:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    input,select{background:#0b1020;border:1px solid #243146;color:var(--text);padding:.6rem .7rem;border-radius:.55rem}
    .right{margin-left:auto}
    .msg{margin-top:.7rem;font-size:.9rem}
    .ok{color:#22c55e}.err{color:#ef4444}
    .badge{display:inline-block;padding:.2rem .5rem;border:1px solid var(--border);border-radius:6px;background:#0b1020;font-size:.85rem}
  </style>
</head>
<body>
  <header>
    <div class="brand">üöö Romaneio</div>
    <span class="chip" id="chipUser">‚Äî</span>
    <div class="right row">
      <button class="btn" id="btnUsers" style="display:none">Usu√°rios</button>
      <button class="btn" id="btnMyPass">Minha senha</button>
      <button class="btn" id="btnLogout">Sair</button>
    </div>
  </header>

  <main>
    <section class="grid two">
      <div class="card">
        <h2>Novo Romaneio</h2>
        <p class="muted">Em breve: formul√°rio completo para registrar romaneios com foto, volumes e impress√£o A4.</p>
        <button class="btn" disabled>Em breve</button>
      </div>

      <div class="card">
        <h2>Meus Romaneios</h2>
        <p class="muted">Filtro por cidade/romaneio e impress√£o. Integra√ß√£o chega no pr√≥ximo passo.</p>
        <button class="btn" disabled>Em breve</button>
      </div>
    </section>

    <section class="card" id="sessBox">
      <h2>Sess√£o</h2>
      <div id="sessInfo" class="muted">‚Äî</div>
      <div id="sessMsg" class="msg"></div>
    </section>

    <section class="card">
      <h2>Tabela de Pre√ßos (Planilha ‚Üí ITENS)</h2>
      <table>
        <thead><tr><th>Embalagem</th><th>Valor</th></tr></thead>
        <tbody id="tbodyItens"><tr><td colspan="2" class="muted">Carregando‚Ä¶</td></tr></tbody>
      </table>
      <div id="itensMsg" class="msg"></div>
    </section>
  </main>

  <!-- MODAL: Usu√°rios (admin) -->
  <div class="modal" id="dlgUsers" aria-hidden="true">
    <div class="panel">
      <div class="row">
        <h2 style="margin-right:auto">Usu√°rios</h2>
        <button class="btn" onclick="dlg('dlgUsers',false)">Fechar</button>
      </div>
      <div class="grid two">
        <div>
          <h3 style="margin:.2rem 0 .5rem">Lista</h3>
          <table>
            <thead><tr><th>Usu√°rio</th><th>Nome</th><th>Perfil</th><th>Ativo</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tbodyUsers"><tr><td colspan="5" class="muted">Carregando‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div>
          <h3 style="margin:.2rem 0 .5rem">Novo usu√°rio</h3>
          <div class="field"><label>Usu√°rio</label><input id="nuUsuario" autocomplete="off"></div>
          <div class="field"><label>Nome</label><input id="nuNome" autocomplete="off"></div>
          <div class="field"><label>Senha</label><input id="nuSenha" type="password" autocomplete="new-password"></div>
          <div class="field"><label>Perfil</label>
            <select id="nuRole">
              <option value="admin">admin</option>
              <option value="operador" selected>operador</option>
            </select>
          </div>
          <div class="row">
            <button class="btn primary" onclick="createUser()">Criar</button>
            <div id="usersMsg" class="msg"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Minha senha -->
  <div class="modal" id="dlgPass" aria-hidden="true">
    <div class="panel" style="max-width:520px">
      <div class="row">
        <h2 style="margin-right:auto">Alterar minha senha</h2>
        <button class="btn" onclick="dlg('dlgPass',false)">Fechar</button>
      </div>
      <div class="field"><label>Senha atual</label><input id="cpAtual" type="password" autocomplete="current-password"></div>
      <div class="field"><label>Nova senha</label><input id="cpNova" type="password" autocomplete="new-password"></div>
      <div class="row">
        <button class="btn primary" onclick="changeMyPass()">Salvar</button>
        <div id="passMsg" class="msg"></div>
      </div>
    </div>
  </div>

  <script>
  // Use a SUA URL com /exec aqui:
  const API_BASE = "https://script.google.com/macros/s/AKfycbwJwVO5VR138hBjVH07DkVqpmpz0-V7wh3FMTEjh7ey-tYaWWITKR37SJUvYxKSaEAB/exec";
</script>

    // ===== helpers =====
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));
    const sess = ()=> JSON.parse(localStorage.getItem("session")||"null");
    const setMsg = (el, text, ok=false)=>{ const n=$(el); if(!n) return; n.textContent=text||""; n.className="msg "+(ok?"ok":"err"); };

    function dlg(id, on=true){ const m=$("#"+id); if(!m) return; m.classList.toggle("on", !!on); m.setAttribute("aria-hidden", on?"false":"true"); }

    async function api(path, body={}, withToken=true){
      const token = withToken && sess()?.token ? "&token="+encodeURIComponent(sess().token) : "";
      try{
        const res = await fetch(API_BASE+"?path="+encodeURIComponent(path)+token,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(body||{})
        });
        return await res.json();
      }catch(e){ return {error:"fetch:"+e}; }
    }

    function requireSession(){
      const s=sess();
      if(!s){ location.href="index.html"; return null; }
      return s;
    }

    // ===== boot =====
    (async function boot(){
      const s=requireSession(); if(!s) return;

      $("#chipUser").textContent = (s.nome||s.usuario)+" ‚Ä¢ "+(s.role||"-");

      // Bot√µes topo
      $("#btnLogout").onclick = ()=>{ localStorage.removeItem("session"); location.href="index.html"; };
      $("#btnMyPass").onclick = ()=>{ $("#cpAtual").value=""; $("#cpNova").value=""; setMsg("#passMsg",""); dlg('dlgPass',true); };

      if((s.role||"") === "admin"){
        $("#btnUsers").style.display="";
        $("#btnUsers").onclick = ()=>{ openUsers(); };
      }

      // Sess√£o box
      $("#sessInfo").textContent = `Usu√°rio: ${s.usuario} ‚Ä¢ Nome: ${s.nome||"-"} ‚Ä¢ Perfil: ${s.role||"-"} ‚Ä¢ Expira: ${new Date(s.expira||s.expira_em||"").toLocaleString()}`;

      // Itens
      await loadItens();
    })();

    // ===== Itens =====
    async function loadItens(){
      const r = await api("/itens/list",{});
      const tb = $("#tbodyItens"); tb.innerHTML="";
      if(r.error){ tb.innerHTML=`<tr><td colspan="2" class="muted">Erro: ${r.error}</td></tr>`; return; }
      if(!r.itens || !r.itens.length){ tb.innerHTML=`<tr><td colspan="2" class="muted">Sem itens definidos na aba ITENS.</td></tr>`; return; }
      r.itens.forEach(i=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${i.embalagem||""}</td><td>R$ ${Number(i.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>`;
        tb.appendChild(tr);
      });
    }

    // ===== Minha senha =====
    async function changeMyPass(){
      setMsg("#passMsg","Salvando‚Ä¶", true);
      const senhaAtual = $("#cpAtual").value.trim();
      const novaSenha  = $("#cpNova").value.trim();
      if(!senhaAtual || !novaSenha){ setMsg("#passMsg","Preencha as duas senhas."); return; }
      const r = await api("/user/changePassword",{senhaAtual,novaSenha});
      if(r.error){ setMsg("#passMsg","Erro: "+r.error); return; }
      setMsg("#passMsg","Senha alterada com sucesso!", true);
      setTimeout(()=> dlg('dlgPass',false), 700);
    }

    // ===== Usu√°rios (admin) =====
    async function openUsers(){
      setMsg("#usersMsg","");
      $("#tbodyUsers").innerHTML = `<tr><td colspan="5" class="muted">Carregando‚Ä¶</td></tr>`;
      dlg('dlgUsers', true);
      await loadUsers();
    }

    async function loadUsers(){
      const r = await api("/users/list",{});
      const tb = $("#tbodyUsers"); tb.innerHTML="";
      if(r.error){ tb.innerHTML=`<tr><td colspan="5" class="muted">Erro: ${r.error}</td></tr>`; return; }
      (r.users||[]).forEach(u=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td><span class="badge">${u.usuario}</span></td>
          <td>${u.nome||""}</td>
          <td>${u.role||""}</td>
          <td>${u.ativo? "‚úÖ":"‚ùå"}</td>
          <td class="row">
            <button class="btn" onclick="resetUserPass('${u.usuario}')">Resetar senha</button>
            <button class="btn" onclick="toggleActive('${u.usuario}', ${!u.ativo})">${u.ativo?"Desativar":"Ativar"}</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      if(!(r.users||[]).length) tb.innerHTML=`<tr><td colspan="5" class="muted">Nenhum usu√°rio.</td></tr>`;
    }

    async function createUser(){
      const usuario=$("#nuUsuario").value.trim();
      const nome=$("#nuNome").value.trim();
      const senha=$("#nuSenha").value.trim();
      const role=$("#nuRole").value;
      if(!usuario || !senha){ setMsg("#usersMsg","Informe usu√°rio e senha."); return; }
      setMsg("#usersMsg","Criando‚Ä¶", true);
      const r = await api("/users/create",{usuario,nome,senha,role});
      if(r.error){ setMsg("#usersMsg","Erro: "+r.error); return; }
      setMsg("#usersMsg","Usu√°rio criado!", true);
      $("#nuUsuario").value=""; $("#nuNome").value=""; $("#nuSenha").value="";
      await loadUsers();
    }

    async function resetUserPass(usuario){
      const novaSenha = prompt("Nova senha para: "+usuario);
      if(!novaSenha) return;
      const r = await api("/users/resetPassword",{usuario,novaSenha});
      if(r.error){ alert("Erro: "+r.error); return; }
      alert("Senha redefinida.");
    }

    async function toggleActive(usuario, ativo){
      const r = await api("/users/setActive",{usuario,ativo});
      if(r.error){ alert("Erro: "+r.error); return; }
      await loadUsers();
    }
  </script>
</body>
</html>
