<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Romaneio ‚Ä¢ Painel</title>
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0d1117;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
      --primary:#2563eb;--border:#1f2a44;--danger:#ef4444;--ok:#16a34a;
      --chip:#111827; --chipText:#cbd5e1;
    }
    /* tema claro */
    :root[data-theme="light"]{
      --bg:#f6f7fb;--panel:#ffffff;--muted:#6b7280;--text:#0f172a;
      --primary:#1d4ed8;--border:#e5e7eb;--danger:#dc2626;--ok:#16a34a;
      --chip:#f3f4f6; --chipText:#374151;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif
    }

    header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;background:linear-gradient(180deg, rgba(0,0,0,.25), transparent 120%), var(--panel);
      border-bottom:1px solid var(--border)
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .brand span{opacity:.85}
    nav{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      background:var(--chip); color:var(--chipText); border:1px solid var(--border);
      padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:600;
      user-select:none; cursor:pointer
    }
    .chip.primary{background:var(--primary);color:#fff;border-color:transparent}
    .chip:hover{opacity:.95}
    .chip.danger{background:var(--danger);color:#fff;border-color:transparent}

    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px}

    h1{margin:0 0 12px 0;font-size:26px}
    h2{margin:22px 0 10px 0;font-size:18px;border-bottom:1px solid var(--border);padding-bottom:8px}

    .grid{display:grid;gap:12px}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.g-3{grid-template-columns:1fr}.g-2{grid-template-columns:1fr}}

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);
      background:transparent;color:var(--text);outline:none
    }
    textarea{min-height:80px;resize:vertical}

    .btn{padding:10px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:var(--chip);color:var(--chipText);border:1px solid var(--border)}
    .btn.danger{background:var(--danger);color:#fff}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left}

    .row-actions{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .total-line{display:flex;justify-content:flex-end;margin-top:6px}
    .pill{display:inline-flex;align-items:center;border-radius:999px;padding:4px 8px;background:var(--chip);color:var(--chipText);font-size:12px;border:1px solid var(--border)}

    /* pr√©-visualiza√ß√£o fotos */
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{position:relative}
    .thumb img{width:76px;height:76px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .thumb button{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border:0;border-radius:50%;width:22px;height:22px;cursor:pointer}

    /* barra de feedback */
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:16px;z-index:50;background:#111827;color:#fff;border:1px solid #334155;
      padding:10px 14px;border-radius:10px;font-weight:600;max-width:90vw
    }
    .toast.ok{background:#064e3b;border-color:#065f46}
    .toast.err{background:#450a0a;border-color:#7f1d1d}

    /* modal comprovante */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;max-width:680px;width:92%;padding:16px}
    .receipt{background:#fff;color:#111;border-radius:12px;padding:16px}
    .receipt h3{margin:0 0 6px 0}
    .receipt table{width:100%;border-collapse:collapse}
    .receipt td,.receipt th{border:1px solid #e5e7eb;padding:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span style="font-size:20px">üöö</span>
      <span>Romaneio</span>
      <span id="userTag" class="pill"></span>
    </div>
    <nav>
      <a class="chip primary" href="#rom">Enviar Romaneio</a>
      <a class="chip" href="#clientes">Clientes</a>
      <a class="chip" href="#roms">Romaneios</a>
      <a class="chip" href="#fin">Financeiro</a>
      <a class="chip" id="usersTab" href="#users">Usu√°rios</a>
      <button id="themeBtn" class="chip" title="Claro/Escuro">üåô/‚òÄÔ∏è</button>
      <button class="chip danger" onclick="logout()">Sair</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- Romaneio -->
    <section id="rom" class="card">
      <h1>Enviar Romaneio</h1>

      <div class="grid g-3">
        <div><label>ROM</label><input id="rom_rom" placeholder="Ex.: 21" inputmode="numeric"></div>
        <div><label>Data</label><input id="rom_data" type="date"></div>
        <div><label>Observa√ß√µes</label><textarea id="rom_obs" placeholder="Ex.: Doca 3, at√© 16h"></textarea></div>
      </div>

      <h2>Cliente</h2>
      <div class="grid g-3">
        <div>
          <label>Telefone</label>
          <input id="cli_tel" placeholder="85999999999" />
          <button class="btn secondary" style="margin-top:6px" onclick="preencherPorTelefone('cli')">Preencher pelo telefone</button>
        </div>
        <div><label>Nome</label><input id="cli_nome" placeholder="Nome do cliente" /></div>
        <div><label>Cidade/UF</label><input id="cli_loc"  placeholder="Fortaleza/CE" /></div>
      </div>

      <h2>Fornecedor <span class="muted" style="font-size:12px">(Opcional)</span></h2>
      <div class="grid g-3">
        <div><label>Telefone</label><input id="for_tel" placeholder="85988887777" /></div>
        <div><label>Nome</label><input id="for_nome" placeholder="Nome do fornecedor" /></div>
        <div><label>Cidade/UF</label><input id="for_loc"  placeholder="Maracana√∫/CE" /></div>
      </div>

      <h2>Itens <span class="total-line">Total: <b style="margin-left:6px" id="rom_total">0</b></span></h2>
      <table id="tblItens">
        <thead>
          <tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th style="width:110px">A√ß√£o</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn secondary" onclick="addItemRow()">+ Item</button></div>

      <h2>Fotos</h2>
      <div class="grid g-1">
        <div>
          <input id="rom_fotos" type="file" accept="image/*" multiple>
          <div style="margin-top:6px" class="muted" id="fotoCount">Nenhuma imagem selecionada.</div>
          <div class="thumbs" id="thumbs"></div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn secondary" onclick="document.getElementById('rom_fotos').click()">+ Adicionar fotos</button>
            <button class="btn" onclick="limparFotos()">Limpar fotos</button>
          </div>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" onclick="enviarRomaneio()">Enviar</button>
        <button class="btn" onclick="limparForm()">Limpar</button>
      </div>

      <div id="rom_result" style="margin-top:14px"></div>
    </section>

    <!-- Placeholders de outras abas -->
    <section id="clientes" class="card" style="margin-top:16px"><h1>Clientes</h1><div class="muted">Em breve.</div></section>
    <section id="roms"     class="card" style="margin-top:16px"><h1>Romaneios</h1><div class="muted">Em breve.</div></section>
    <section id="fin"      class="card" style="margin-top:16px"><h1>Financeiro</h1><div class="muted">Em breve.</div></section>
    <section id="users"    class="card" style="margin-top:16px"><h1>Usu√°rios</h1><div class="muted">Gerenciamento dispon√≠vel quando o backend /users estiver ativo.</div></section>
  </main>

  <!-- toast -->
  <div id="toast" class="toast" style="display:none"></div>

  <!-- modal comprovante -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h2 style="margin-top:0">Comprovante do Romaneio</h2>
      <div id="receipt" class="receipt">
        <!-- preenchido via JS -->
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <a id="pdfLink" class="btn primary" target="_blank">Abrir PDF</a>
        <a id="waLink"  class="btn" target="_blank">WhatsApp do cliente</a>
        <button class="btn secondary" onclick="baixarImagemComprovante()">Baixar imagem</button>
        <button class="btn danger" onclick="fecharModal()">Fechar</button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec"; // <-- troque se necess√°rio

/* ====== HELPERS ====== */
const $ = (s)=>document.querySelector(s);
const fmtDateInput = (d=new Date()) => {
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
function toast(msg, cls=""){ const t=$("#toast"); t.textContent=msg; t.className="toast "+cls; t.style.display="block"; setTimeout(()=>{t.style.display="none"}, 3000); }
function sess(){ try { return JSON.parse(localStorage.getItem("session"))||null; } catch(_) { return null; } }

async function api(path, body = {}) {
  const s = sess();
  const url = API_BASE + "?path=" + encodeURIComponent(path);
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify({...body, token: s?.token}),
    cache: "no-store"
  });
  return res.json();
}

/* ====== TEMA (dark/light) ====== */
function applyTheme(){
  const th = localStorage.getItem("theme") || "dark";
  document.documentElement.setAttribute("data-theme", th);
}
function toggleTheme(){
  const cur = localStorage.getItem("theme") || "dark";
  const next = cur === "dark" ? "light" : "dark";
  localStorage.setItem("theme", next);
  applyTheme();
}
$("#themeBtn").addEventListener("click", toggleTheme);

/* ====== GUARDA DE SESS√ÉO ====== */
async function guard(){
  applyTheme();
  const s = sess();
  if(!s?.token){ location.href="index.html"; return; }
  try{
    const r = await api("/whoami");
    if(!r?.session?.usuario){ localStorage.removeItem("session"); location.href="index.html"; return; }
    $("#userTag").textContent = r.session.usuario;
    // data hoje
    $("#rom_data").value = fmtDateInput(new Date());
  }catch(_){
    localStorage.removeItem("session");
    location.href="index.html";
  }
}

/* ====== ITENS ====== */
function addItemRow(tipo="caixa", tam="p", qtd=1){
  const tb = $("#tblItens tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select class="tipo">
        <option value="caixa"${tipo==="caixa"?" selected":""}>Caixa</option>
        <option value="saco"${tipo==="saco"?" selected":""}>Saco</option>
      </select>
    </td>
    <td>
      <select class="tam">
        <option value="p"${tam==="p"?" selected":""}>P</option>
        <option value="m"${tam==="m"?" selected":""}>M</option>
        <option value="g"${tam==="g"?" selected":""}>G</option>
      </select>
    </td>
    <td>
      <input type="number" min="0" class="qtd" value="${qtd}">
    </td>
    <td class="row-actions">
      <button class="btn danger" onclick="this.closest('tr').remove(); calcTotal()">Remover</button>
    </td>
  `;
  tb.appendChild(tr);
  calcTotal();
}
function calcTotal(){
  let tot=0;
  document.querySelectorAll("#tblItens .qtd").forEach(i=> tot += Number(i.value||0));
  $("#rom_total").textContent = tot;
}
document.addEventListener("input", (e)=>{ if (e.target.classList.contains("qtd")) calcTotal(); });

/* ====== FOTOS (multi + pr√©-visualiza√ß√£o) ====== */
let fotosSelecionadas = []; // {file, dataUrl}

function limparFotos(){
  fotosSelecionadas = [];
  $("#rom_fotos").value = "";
  renderThumbs();
}
function renderThumbs(){
  const cont = $("#thumbs");
  cont.innerHTML = "";
  fotosSelecionadas.forEach((f,idx)=>{
    const d = document.createElement("div");
    d.className="thumb";
    d.innerHTML = `<img src="${f.dataUrl}"><button onclick="remFoto(${idx})">√ó</button>`;
    cont.appendChild(d);
  });
  $("#fotoCount").textContent = fotosSelecionadas.length ? `${fotosSelecionadas.length} foto(s)` : "Nenhuma imagem selecionada.";
}
function remFoto(i){
  fotosSelecionadas.splice(i,1);
  renderThumbs();
}
$("#rom_fotos").addEventListener("change", async (ev)=>{
  const files = Array.from(ev.target.files||[]);
  for (const file of files){
    const dataUrl = await new Promise(res=>{
      const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);
    });
    fotosSelecionadas.push({file, dataUrl});
  }
  renderThumbs();
});

/* ====== PREENCHER POR TELEFONE (placeholder) ====== */
function preencherPorTelefone(prefix){
  // se tiver uma base local, poderia preencher. Mantive apenas um helper simples.
  toast("Busca por telefone n√£o implementada (placeholder).", "");
}

/* ====== LIMPAR FORM ====== */
function limparForm(){
  $("#rom_rom").value = "";
  $("#rom_data").value = fmtDateInput(new Date());
  $("#rom_obs").value = "";
  $("#cli_tel").value = ""; $("#cli_nome").value = ""; $("#cli_loc").value = "";
  $("#for_tel").value = ""; $("#for_nome").value = ""; $("#for_loc").value = "";
  $("#tblItens tbody").innerHTML = "";
  addItemRow();
  limparFotos();
  $("#rom_result").innerHTML = "";
}

/* ====== MODAL ====== */
function abrirModal(){ $("#overlay").style.display="flex"; }
function fecharModal(){ $("#overlay").style.display="none"; }

/* gera imagem do conte√∫do do recibo (canvas simples via SVG) */
async function baixarImagemComprovante(){
  const node = document.getElementById("receipt");
  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="1200">
  <foreignObject width="1200" height="800">
    <div xmlns="http://www.w3.org/1999/xhtml" style="font-family:Arial,sans-serif;padding:16px;background:#fff;color:#111">
      ${node.innerHTML}
    </div>
  </foreignObject>
</svg>`;
  const blob = new Blob([svg], {type:"image/svg+xml"});
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement("canvas");
    const scale = 2;
    canvas.width = img.width*scale;
    canvas.height = img.height*scale;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    URL.revokeObjectURL(url);
    canvas.toBlob(b=>{
      const a = document.createElement("a");
      a.href = URL.createObjectURL(b);
      a.download = "comprovante_romaneio.png";
      a.click();
      URL.revokeObjectURL(a.href);
    },"image/png",0.92);
  };
  img.src = url;
}

/* ====== ENVIAR ====== */
async function enviarRomaneio(){
  try{
    const itens = Array.from(document.querySelectorAll("#tblItens tbody tr")).map(tr=>({
      tipo: tr.querySelector(".tipo").value,
      tamanho: tr.querySelector(".tam").value,
      qtd: Number(tr.querySelector(".qtd").value||0)
    })).filter(i=>i.qtd>0);

    const body = {
      rom: $("#rom_rom").value,
      data: $("#rom_data").value,
      obs : $("#rom_obs").value,
      cliente: { tel: $("#cli_tel").value, nome: $("#cli_nome").value, local: $("#cli_loc").value },
      fornecedor: { tel: $("#for_tel").value, nome: $("#for_nome").value, local: $("#for_loc").value },
      itens,
      fotos: fotosSelecionadas.map(f => ({ name: f.file?.name || "foto.jpg", data: f.dataUrl }))
    };

    $("#rom_result").innerHTML = `<span class="pill">Enviando...</span>`;
    const r = await api("/rom/create", body);
    if (r.error){
      $("#rom_result").innerHTML = `<div class="toast err" style="display:block">Erro: ${r.error}</div>`;
      return;
    }

    // sucesso: mostra modal de comprovante
    const receipt = document.getElementById("receipt");
    receipt.innerHTML = `
      <h3 style="margin:0 0 8px">ROMANEIO <b>${r.cod}</b></h3>
      <div><b>Data:</b> ${body.data || "(hoje)"}</div>
      <div style="margin-top:4px"><b>Cliente:</b> ${body.cliente?.nome||""} (${body.cliente?.tel||""}) ‚Äî ${body.cliente?.local||""}</div>
      ${body.fornecedor?.tel?`<div><b>Fornecedor:</b> ${body.fornecedor?.nome||""} (${body.fornecedor?.tel||""}) ‚Äî ${body.fornecedor?.local||""}</div>`:""}
      ${body.obs ? `<div style="margin-top:4px"><b>Obs.:</b> ${body.obs}</div>`:""}
      <h4 style="margin:10px 0 6px">Itens</h4>
      <table>
        <thead><tr><th>Item</th><th>Qtd</th></tr></thead>
        <tbody>
          ${body.itens.map(i=>`<tr><td>${i.tipo.toUpperCase()} ${i.tamanho.toUpperCase()}</td><td>${i.qtd}</td></tr>`).join("")}
        </tbody>
      </table>
      <div style="margin-top:8px"><b>Total:</b> ${body.itens.reduce((s,i)=>s+Number(i.qtd||0),0)}</div>
    `;
    document.getElementById("pdfLink").href = r.pdfUrl;
    document.getElementById("waLink").href  = r.whatsappUrl;
    abrirModal();
    toast("Romaneio criado. C√≥digo: "+r.cod, "ok");

    // limpa form
    limparForm();
  }catch(err){
    $("#rom_result").innerHTML = `<div class="toast err" style="display:block">Falha: ${err.message}</div>`;
  }
}

/* ====== LOGOUT ====== */
async function logout(){
  try{ await api("/logout",{}); }catch(_){}
  localStorage.removeItem("session");
  location.href="index.html";
}

/* ====== INIT ====== */
window.addEventListener("DOMContentLoaded", ()=>{
  guard();
  // inicia com uma linha
  addItemRow();
  // navega√ß√£o simples por hash (s√≥ pra dar sensa√ß√£o de SPA)
  function show(tab){
    ["rom","clientes","roms","fin","users"].forEach(id=>{
      document.getElementById(id).style.display = (id===tab)?"block":"none";
    });
  }
  const h = (location.hash||"#rom").replace("#","");
  show(h);
  window.addEventListener("hashchange", ()=> show((location.hash||"#rom").replace("#","")));
});
</script>
</body>
</html>
