<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta name="theme-color" content="#0d1117" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />

  <!-- jsPDF para PDF local (download/compartilhar) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0d1117;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
      --primary:#2563eb;--border:#1f2a44;--panel-soft:#0b1220;
      --success:#22c55e;--danger:#ef4444;--info:#93c5fd;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:.75rem 1rem;background:#0b0f1a;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
    header .title{font-weight:700;letter-spacing:.2px}
    nav a{margin-left:14px;color:var(--muted);text-decoration:none;font-weight:600}
    nav a:hover{color:var(--primary)}
    nav a.active{color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h2{margin:12px 0 10px 0;font-size:1.2rem}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    .card.soft{background:var(--panel-soft)}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.g2,.g3{grid-template-columns:1fr}}
    .input{width:100%;background:#0b0f1a;color:var(--text);border:1px solid #24334d;border-radius:10px;padding:10px}
    .input:focus{outline:none;border-color:#3b82f6}
    .btn{padding:.6rem 1rem;background:var(--primary);border:0;border-radius:10px;color:#fff;cursor:pointer;font-weight:700}
    .btn:hover{opacity:.95}
    .btn.ghost{background:#0b0f1a;border:1px solid #24334d}
    .btn.sm{padding:.45rem .7rem;border-radius:8px;font-weight:600}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem .75rem;border-bottom:1px solid var(--border);text-align:left}
    th{background:#111827}
    .muted{color:var(--muted)}
    .ok{color:var(--success)} .err{color:var(--danger)} .info{color:var(--info)}
    .filelist{font-size:.9rem;opacity:.85;margin-top:6px}
    .fileitem{display:flex;align-items:center;gap:8px;margin:4px 0}
    .pill{display:inline-block;padding:.2rem .5rem;border:1px solid var(--border);border-radius:999px;font-size:.8rem}
    .right{ text-align:right }
    /* Loader overlay */
    #loader{position:fixed;inset:0;background:rgba(2,6,23,.6);
      backdrop-filter:saturate(1.2) blur(2px);
      display:none;align-items:center;justify-content:center;z-index:9999}
    #loader .box{width:min(380px,92vw);background:#0b1220;border:1px solid #1e293b;border-radius:16px;padding:16px}
    #loader .barwrap{height:10px;background:#0f172a;border:1px solid #24334d;border-radius:9999px;overflow:hidden}
    #loader .bar{height:100%;width:30%;background:#3b82f6;transition:width .2s}
    .hint{font-size:.8rem;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="title">üöö Romaneio</div>
    <nav id="topnav">
      <a href="#" data-tab="rom-form" class="active">Enviar Romaneio</a>
      <a href="#" data-tab="clientes">Clientes</a>
      <a href="#" data-tab="romaneios">Romaneios</a>
      <a href="#" data-tab="financeiro">Financeiro</a>
      <a href="#" id="btnSair">Sair</a>
    </nav>
  </header>

  <main class="wrap">
    <!-- ====== ENVIAR ROMANEIO (principal) ====== -->
    <section id="rom-form" class="tab">
      <div class="card">
        <div class="toolbar" style="justify-content:space-between">
          <h2>Enviar Romaneio</h2>
          <span id="userChip" class="pill"></span>
        </div>

        <div class="grid g3">
          <div>
            <label class="muted">ROM</label>
            <input id="rom_rom" class="input" type="number" min="1" placeholder="Ex.: 21" />
          </div>
          <div>
            <label class="muted">Data</label>
            <input id="rom_data" class="input" type="date" />
          </div>
          <div>
            <label class="muted">Observa√ß√µes</label>
            <textarea id="rom_obs" class="input" rows="1" placeholder="Ex.: Agendar com o cliente"></textarea>
          </div>
        </div>

        <div class="grid g2" style="margin-top:14px">
          <div class="card soft">
            <div class="toolbar" style="justify-content:space-between">
              <div class="muted" style="font-weight:700">Cliente</div>
              <span class="pill">Preencha pelo telefone</span>
            </div>
            <div class="grid g3" style="margin-top:8px">
              <div>
                <label class="muted">Telefone</label>
                <input id="cli_tel" class="input" placeholder="(DDD) 90000-0000" />
              </div>
              <div>
                <label class="muted">Nome</label>
                <input id="cli_nome" class="input" placeholder="Nome do cliente" />
              </div>
              <div>
                <label class="muted">Cidade/UF</label>
                <input id="cli_loc" class="input" placeholder="Fortaleza-CE" />
              </div>
            </div>
          </div>

          <div class="card soft">
            <div class="toolbar" style="justify-content:space-between">
              <div class="muted" style="font-weight:700">Fornecedor</div>
              <span class="pill">Opcional</span>
            </div>
            <div class="grid g3" style="margin-top:8px">
              <div>
                <label class="muted">Telefone</label>
                <input id="for_tel" class="input" placeholder="(DDD) 90000-0000" />
              </div>
              <div>
                <label class="muted">Nome</label>
                <input id="for_nome" class="input" placeholder="Nome do fornecedor" />
              </div>
              <div>
                <label class="muted">Cidade/UF</label>
                <input id="for_loc" class="input" placeholder="Cidade-UF" />
              </div>
            </div>
          </div>
        </div>

        <div class="card soft" style="margin-top:14px">
          <div class="toolbar" style="justify-content:space-between">
            <div style="font-weight:700">Itens</div>
            <button class="btn sm ghost" id="btnAddItem">+ Item</button>
          </div>
          <div style="margin-top:8px;overflow:auto">
            <table>
              <thead>
                <tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th class="right">A√ß√£o</th></tr>
              </thead>
              <tbody id="itensBody"></tbody>
            </table>
            <div class="right muted" style="margin-top:8px">Total: <span id="rom_total">0</span></div>
          </div>
        </div>

        <div class="card soft" style="margin-top:14px">
          <div class="toolbar" style="justify-content:space-between">
            <div style="font-weight:700">Fotos</div>
            <div class="hint">Voc√™ pode escolher v√°rias e remover antes de enviar.</div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <input id="inFotos" type="file" accept="image/*" multiple capture="environment" style="display:none">
            <button class="btn sm ghost" id="btnAddFotos">Adicionar fotos</button>
            <div id="fotosCount" class="muted"></div>
          </div>
          <div id="listaFotos" class="filelist"></div>
        </div>

        <div class="toolbar" style="margin-top:14px">
          <button id="btnEnviarRom" class="btn">Enviar Romaneio</button>
          <div id="romMsg" class="muted"></div>
        </div>
      </div>
    </section>

    <!-- ====== Clientes (separado) ====== -->
    <section id="clientes" class="tab" style="display:none">
      <div class="card">
        <div class="toolbar" style="justify-content:space-between">
          <h2>Clientes</h2>
          <button class="btn sm ghost" onclick="carregarClientes()">üîÑ Atualizar</button>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="tblClientes">
            <thead><tr><th>Telefone</th><th>Nome</th><th>Cidade/UF</th><th>Criado em</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:6px">Obs.: esta aba s√≥ atualiza quando voc√™ clicar.</div>
      </div>
    </section>

    <!-- ====== Romaneios / Financeiro (placeholders) ====== -->
    <section id="romaneios" class="tab" style="display:none">
      <div class="card">
        <h2>Romaneios</h2>
        <div class="muted">Lista/relat√≥rios entram aqui numa pr√≥xima etapa.</div>
      </div>
    </section>

    <section id="financeiro" class="tab" style="display:none">
      <div class="card">
        <h2>Financeiro</h2>
        <div class="muted">Vis√£o financeira entrar√° na etapa 2.</div>
      </div>
    </section>
  </main>

  <!-- Loader/Overlay -->
  <div id="loader">
    <div class="box">
      <div id="loaderText" style="color:#e5e7eb;font:600 14px system-ui;margin-bottom:10px">Processando...</div>
      <div class="barwrap"><div id="loaderBar" class="bar"></div></div>
    </div>
  </div>

<script>
/* ================== CONFIG & SESSION ================== */
// TROQUE AQUI PELO SEU /exec
const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec";

const $ = (sel, ctx=document)=> ctx.querySelector(sel);
const $$ = (sel, ctx=document)=> Array.from(ctx.querySelectorAll(sel));

function sess(){
  try { return JSON.parse(localStorage.getItem("session"))||null; } catch(_) { return null; }
}

/* ================== NAV/TABS ================== */
function showTab(id){
  $$(".tab").forEach(s=> s.style.display = (s.id===id ? "" : "none"));
  $$("#topnav a[data-tab]").forEach(a=> a.classList.toggle("active", a.dataset.tab===id));
}
$("#topnav").addEventListener("click", (e)=>{
  const a = e.target.closest("a[data-tab]");
  if(!a) return;
  e.preventDefault();
  showTab(a.dataset.tab);
});

/* ================== LOADER (GLOBAL) ================== */
function showLoader(txt="Processando...", pct=null){
  $("#loaderText").textContent = txt;
  $("#loaderBar").style.width = (pct==null ? "30%" : Math.max(3, Math.min(100, pct))+"%");
  $("#loader").style.display = "flex";
}
function updateLoader(p){ $("#loaderBar").style.width = Math.max(3, Math.min(100, p))+"%"; }
function hideLoader(){ $("#loader").style.display = "none"; }

/* ================== API WRAPPER ================== */
async function api(path, body = {}, token = null){
  const url = API_BASE + "?path=" + encodeURIComponent(path);
  const session = sess();
  const payload = { ...body, token: token || session?.token };

  showLoader("Comunicando com o servidor...", null);
  try{
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload),
      cache: "no-store"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    updateLoader(70);
    const json = await res.json();
    updateLoader(100);
    return json;
  }finally{
    setTimeout(hideLoader,150);
  }
}

/* ================== UI HELPERS ================== */
function setMsg(txt, kind="info"){
  const el = $("#romMsg");
  el.className = kind;
  el.textContent = txt;
}
function normalizePhone(t){
  return String(t||"").replace(/\D/g,"").replace(/^55/,"");
}

/* ================== ITENS (din√¢mico) ================== */
const tipos = ["Caixa","Saco"];
const tams  = ["P","M","G"];
function addItemRow(tipo="Caixa", tam="P", qtd=1){
  const tb = $("#itensBody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select class="input tipo">${tipos.map(v=>`<option ${v===tipo?'selected':''}>${v}</option>`).join('')}</select>
    </td>
    <td>
      <select class="input tam">${tams.map(v=>`<option ${v===tam?'selected':''}>${v}</option>`).join('')}</select>
    </td>
    <td><input type="number" min="1" value="${qtd}" class="input qtd" style="max-width:120px"></td>
    <td class="right"><button class="btn sm ghost rm">Remover</button></td>
  `;
  tb.appendChild(tr);
  tr.querySelector(".rm").onclick = ()=>{ tr.remove(); recalcTotal(); };
  tr.querySelector(".qtd").oninput = recalcTotal;
  recalcTotal();
}
function recalcTotal(){
  let tot=0;
  $$("#itensBody .qtd").forEach(i=> tot += Number(i.value||0));
  $("#rom_total").textContent = tot;
}
$("#btnAddItem").addEventListener("click", (e)=>{ e.preventDefault(); addItemRow(); });

/* ================== FOTOS (multi + preview/remover) ================== */
const inFotos = $("#inFotos");
const listaFotos = $("#listaFotos");
const fotosCount = $("#fotosCount");
$("#btnAddFotos").addEventListener("click",(e)=>{ e.preventDefault(); inFotos.click(); });

let fotosQueue = []; // [{file, name, dataUrl}]
inFotos.addEventListener("change", async ()=>{
  const files = Array.from(inFotos.files||[]);
  for (const f of files){
    const dataUrl = await fileToDataUrl(f);
    fotosQueue.push({ file:f, name:f.name, dataUrl });
  }
  renderFotosList();
  inFotos.value = ""; // permite re-selecionar as mesmas
});
function renderFotosList(){
  listaFotos.innerHTML = "";
  fotosQueue.forEach((f,idx)=>{
    const div = document.createElement("div");
    div.className = "fileitem";
    div.innerHTML = `
      <span>üì∑</span>
      <span style="flex:1">${f.name}</span>
      <button class="btn sm ghost">remover</button>`;
    div.querySelector("button").onclick = ()=>{ fotosQueue.splice(idx,1); renderFotosList(); };
    listaFotos.appendChild(div);
  });
  fotosCount.textContent = fotosQueue.length ? `${fotosQueue.length} selecionada(s)` : "";
}
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* ================== PDF LOCAL (jsPDF) ================== */
async function makeRomaneioPDF({cod, rom, data, obs, cliente, fornecedor, itens, usuario}){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  const line = y => doc.line(40, y, 555, y);

  doc.setFont("helvetica","bold"); doc.setFontSize(16);
  doc.text("ROMANEIO", 40, 50);
  doc.setFont("helvetica","normal"); doc.setFontSize(10);
  doc.text(`Gerado em ${new Date().toLocaleString()} por ${usuario||"-"}`, 40, 68);

  line(80);
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text(`C√ìDIGO: ${cod}`, 40, 105);
  doc.setFont("helvetica","normal");
  doc.text(`ROM: ${rom||"-"}`, 220, 105);
  doc.text(`DATA: ${data||"-"}`, 360, 105);

  line(120);
  doc.setFont("helvetica","bold");
  doc.text("Cliente", 40, 145);
  doc.setFont("helvetica","normal");
  doc.text(`Tel.: ${cliente?.tel||"-"}  |  Nome: ${cliente?.nome||"-"}`, 40, 162);
  doc.text(`Cidade/UF: ${cliente?.local||cliente?.cidadeUF||"-"}`, 40, 178);

  doc.setFont("helvetica","bold");
  doc.text("Fornecedor", 40, 206);
  doc.setFont("helvetica","normal");
  doc.text(`Tel.: ${fornecedor?.tel||"-"}  |  Nome: ${fornecedor?.nome||"-"}`, 40, 222);
  doc.text(`Cidade/UF: ${fornecedor?.local||fornecedor?.cidadeUF||"-"}`, 40, 238);

  line(252);
  doc.setFont("helvetica","bold");
  doc.text("Itens", 40, 275);
  doc.setFont("helvetica","normal");
  let y = 295;
  doc.setFont("helvetica","bold");
  doc.text("Tipo", 40, y); doc.text("Tam", 180, y); doc.text("Qtd", 260, y);
  doc.setFont("helvetica","normal"); y+=16;
  let total = 0;
  (itens||[]).forEach(it=>{
    doc.text(String(it.tipo||"-"), 40, y);
    doc.text(String(it.tam||it.tamanho||"-"), 180, y);
    doc.text(String(it.qtd||"0"), 260, y);
    total += Number(it.qtd||0); y += 16;
    if (y > 720) { doc.addPage(); y = 60; }
  });
  y += 10; doc.setFont("helvetica","bold"); doc.text(`TOTAL: ${total}`, 40, y);

  y += 24; doc.setFont("helvetica","bold"); doc.text("Observa√ß√µes", 40, y);
  y += 16; doc.setFont("helvetica","normal");
  const obsLines = doc.splitTextToSize(String(obs||"-"), 515);
  doc.text(obsLines, 40, y);

  const fileName = `ROM_${cod}.pdf`;
  const blob = doc.output("blob");
  const url = URL.createObjectURL(blob);
  return { blob, url, fileName };
}

/* ================== ENVIAR ================== */
$("#btnEnviarRom").addEventListener("click", enviarRomaneio);
async function enviarRomaneio(){
  try{
    setMsg("Validando...", "info");

    const session = sess();
    if(!session){ setMsg("Sess√£o expirada. Fa√ßa login novamente.", "err"); return; }

    const itens = $$("#itensBody tr").map(tr=>({
      tipo: tr.querySelector(".tipo").value.toLowerCase(),
      tamanho: tr.querySelector(".tam").value.toLowerCase(),
      qtd: Number(tr.querySelector(".qtd").value||0)
    })).filter(i=>i.qtd>0);

    if (!itens.length){ setMsg("Adicione pelo menos 1 item.", "err"); return; }

    const fotos = fotosQueue.map(f => ({ name: f.name, data: f.dataUrl }));

    const body = {
      rom: $("#rom_rom").value,
      data: $("#rom_data").value,
      obs : $("#rom_obs").value,
      cliente: {
        tel: $("#cli_tel").value,
        nome: $("#cli_nome").value,
        local: $("#cli_loc").value
      },
      fornecedor: {
        tel: $("#for_tel").value,
        nome: $("#for_nome").value,
        local: $("#for_loc").value
      },
      itens, fotos
    };

    setMsg("Enviando romaneio...", "info");
    const r = await api("/rom/create", body, session.token);
    if (r.error) { setMsg("Erro: "+r.error, "err"); return; }

    // PDF local (sem Drive)
    const pdf = await makeRomaneioPDF({
      cod: r.cod, rom: body.rom, data: body.data,
      obs: body.obs, cliente: body.cliente, fornecedor: body.fornecedor,
      itens: body.itens, usuario: session.usuario
    });

    // UI de resultado
    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <div class="ok" style="margin-top:6px"><b>Romaneio criado!</b> C√≥digo: <b>${r.cod}</b></div>
      <div class="grid g2" style="margin-top:8px">
        <div class="card soft">
          <div class="muted" style="margin-bottom:6px">PDF do servidor (Drive)</div>
          <a class="btn sm" target="_blank" href="${r.pdfUrl}">Abrir PDF</a>
          <a class="btn sm ghost" target="_blank" href="${r.whatsappUrl}" style="margin-left:6px">WhatsApp do cliente</a>
        </div>
        <div class="card soft">
          <div class="muted" style="margin-bottom:6px">PDF local (navegador)</div>
          <a class="btn sm" id="btnDownLocal">Baixar PDF</a>
          <button class="btn sm ghost" id="btnShareLocal" style="margin-left:6px">Compartilhar (WhatsApp)</button>
        </div>
      </div>
      <div class="hint" style="margin-top:6px">No desktop, o WhatsApp Web n√£o recebe anexos automaticamente ‚Äî abra a conversa e anexe o PDF baixado. No celular Android, o bot√£o "Compartilhar" envia o arquivo direto.</div>
    `;
    const result = $("#romMsg");
    result.className = ""; result.innerHTML = ""; result.appendChild(wrap);

    // Bot√£o: baixar PDF local
    $("#btnDownLocal").onclick = ()=>{
      const a = document.createElement("a");
      a.href = pdf.url; a.download = pdf.fileName; a.click();
    };

    // Bot√£o: compartilhar (mobile)
    $("#btnShareLocal").onclick = async ()=>{
      try{
        if (navigator.canShare && navigator.canShare({ files: [ new File([pdf.blob], pdf.fileName, {type:"application/pdf"}) ] })) {
          await navigator.share({
            title: `Romaneio ${r.cod}`,
            text: `Romaneio ${r.cod} - ${body.cliente?.nome||""}`,
            files: [ new File([pdf.blob], pdf.fileName, {type:"application/pdf"}) ]
          });
        } else {
          // fallback: abre WhatsApp Web s√≥ com texto
          const tel = normalizePhone(body.cliente?.tel);
          const texto = encodeURIComponent(`Romaneio ${r.cod} enviado. Vou anexar o PDF.`);
          const url = tel ? `https://wa.me/55${tel}?text=${texto}` : `https://web.whatsapp.com/send?text=${texto}`;
          window.open(url, "_blank");
        }
      }catch(e){}
    };

    // limpa formul√°rio leve
    fotosQueue = []; renderFotosList();
    $$("#itensBody tr").forEach(tr=>tr.remove()); addItemRow();
    recalcTotal();
  }catch(err){
    setMsg("Falha ao enviar: "+(err.message||err), "err");
  }
}

/* ================== CLIENTES (placeholder seguro) ================== */
async function carregarClientes(){
  try{
    setMsg("Carregando clientes...", "info");
    // Se n√£o houver endpoint espec√≠fico, leia direto da planilha via novo endpoint futuro.
    // Por enquanto, evita erro:
    const tbody = $("#tblClientes tbody");
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Endpoint de clientes ser√° habilitado na pr√≥xima etapa.</td></tr>`;
    setMsg("", "info");
  }catch(e){
    setMsg("Erro ao carregar clientes.", "err");
  }
}

/* ================== SAIR ================== */
$("#btnSair").addEventListener("click", (e)=>{
  e.preventDefault();
  localStorage.removeItem("session");
  location.href = "index.html";
});

/* ================== BOOT ================== */
(function boot(){
  const s = sess();
  if (s) $("#userChip").textContent = `${s.usuario} ‚Ä¢ ${s.role||''}`;
  // valores padr√£o
  const today = new Date().toISOString().slice(0,10);
  $("#rom_data").value = today;
  // primeira linha de itens
  addItemRow();
  showTab("rom-form");
})();
</script>
</body>
</html>
