<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio • Painel</title>
  <meta name="theme-color" content="#0d1117" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#98a2b3; --text:#e6edf3;
      --primary:#2563eb; --primary-2:#1d4ed8; --border:#1f2a44;
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%,rgba(37,99,235,.18),transparent 60%),var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:.75rem 14px;background:#0b0f1a;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
    header .brand{display:flex;gap:8px;align-items:center;font-weight:700}
    nav a{margin-left:16px;color:var(--muted);text-decoration:none;font-weight:600}
    nav a:hover{color:var(--primary)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h2{margin:10px 0 14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .row{margin:.5rem 0}
    label{font-size:12px;color:var(--muted);display:block;margin:.1rem 0 .35rem}
    input,textarea,select{width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px}
    textarea{min-height:76px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{color:#cbd5e1}
    .btn{padding:.6rem 1rem;background:var(--primary);border:0;border-radius:10px;color:#fff;font-weight:800;cursor:pointer}
    .btn:hover{background:var(--primary-2)}
    .btn-sm{padding:.35rem .6rem;border-radius:8px}
    .right{display:flex;justify-content:flex-end}
    .muted{color:var(--muted);font-size:12px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
    .bar{width:220px;height:8px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#2563eb,#60a5fa);animation:load 1.2s infinite}
    @keyframes load{0%{width:0}50%{width:90%}100%{width:0;transform:translateX(100%)}}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0b1220;border:1px solid var(--border);padding:10px 14px;border-radius:10px;display:none;z-index:60}
    .toast.ok{border-color:rgba(22,163,74,.5)}
    .toast.err{border-color:rgba(220,38,38,.5)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#0b1220;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="brand">🚚 Romaneio</div>
    <nav>
      <a href="#" onclick="showTab('rom-enviar')">Enviar Romaneio</a>
      <a href="#" onclick="showTab('rom-lista')">Romaneios</a>
      <a href="#" onclick="showTab('clientes')">Clientes</a>
      <a href="#" onclick="logout()">Sair</a>
    </nav>
  </header>

  <main class="wrap">
    <!-- ======== ENVIAR ROMANEIO ======== -->
    <section id="rom-enviar" class="tab">
      <h2>Enviar Romaneio</h2>
      <div class="card">
        <div class="grid-3">
          <div class="row">
            <label>ROM</label>
            <input id="rom_rom" type="number" placeholder="Ex.: 21">
          </div>
          <div class="row">
            <label>Data</label>
            <input id="rom_data" type="date">
          </div>
          <div class="row">
            <label>Observações</label>
            <textarea id="rom_obs" placeholder="Ex.: Agendar com o cliente"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="badge">Cliente</span>
        </div>
        <div class="grid-3">
          <div class="row">
            <label>Telefone</label>
            <input id="cli_tel" placeholder="(DDD) 90000-0000">
          </div>
          <div class="row">
            <label>Nome</label>
            <input id="cli_nome" placeholder="Nome do cliente">
          </div>
          <div class="row">
            <label>Cidade/UF</label>
            <input id="cli_loc" placeholder="Fortaleza-CE">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="badge">Fornecedor <small style="opacity:.6">Opcional</small></span>
        </div>
        <div class="grid-3">
          <div class="row">
            <label>Telefone</label>
            <input id="for_tel" placeholder="(DDD) 90000-0000">
          </div>
          <div class="row">
            <label>Nome</label>
            <input id="for_nome" placeholder="Nome do fornecedor">
          </div>
          <div class="row">
            <label>Cidade/UF</label>
            <input id="for_loc" placeholder="Cidade-UF">
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <span class="badge">Itens</span>
        </div>
        <table id="tblItens">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Tamanho</th>
              <th>Qtd</th>
              <th class="right"><button class="btn btn-sm" type="button" onclick="addItemRow()">+ Item</button></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="4" class="right"><b>Total: <span id="rom_total">0</span></b></td></tr>
          </tfoot>
        </table>

        <div class="row" style="margin-top:14px">
          <span class="badge">Fotos</span>
        </div>
        <div class="row">
          <input id="rom_fotos" type="file" accept="image/*" multiple capture="environment">
          <div class="muted" style="margin-top:6px">Você pode escolher várias e remover antes de enviar.</div>
        </div>

        <div class="row" style="margin-top:16px">
          <button class="btn" type="button" onclick="enviarRomaneio()">Enviar Romaneio</button>
        </div>

        <div id="rom_result" class="row" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- tabs “Romaneios” e “Clientes” (placeholders simples por enquanto) -->
    <section id="rom-lista" class="tab" style="display:none">
      <h2>Romaneios</h2>
      <div class="card muted">Lista em breve.</div>
    </section>

    <section id="clientes" class="tab" style="display:none">
      <h2>Clientes</h2>
      <div class="card muted">Lista em breve.</div>
    </section>
  </main>

  <!-- overlay + toast -->
  <div id="overlay" class="overlay"><div class="bar"><span></span></div></div>
  <div id="toast" class="toast"></div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbWJwVO5VR138hBjVH07DkVqpmpz0-V7wh3FMTEjh7ey-tYaWWITKR37SJUvYxKSaEAB/exec";

/* ====== helpers UI ====== */
const $ = (s)=>document.querySelector(s);
function setLoading(v){ $("#overlay").style.display = v ? "flex" : "none"; }
function toast(msg, kind="ok"){ const t=$("#toast"); t.textContent=msg; t.className="toast "+kind; t.style.display="block"; setTimeout(()=>t.style.display="none", 3000); }
function sess(){ try { return JSON.parse(localStorage.getItem("session"))||null; } catch(_) { return null; } }

/* ====== guard de sessão (sem loop) ====== */
(async function guard(){
  const s = sess();
  if(!s?.token){ location.replace("index.html"); return; }
  setLoading(true);
  let ok=false;
  try{
    const r = await fetch(API_BASE+"?path=whoami", {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ token: s.token }),
      cache:"no-store"
    }).then(x=>x.json());
    ok = !!r?.session?.token;
  }catch(_){}
  setLoading(false);
  if(!ok){
    localStorage.removeItem("session");
    location.replace("index.html");
  }
})();

/* ====== navegação básica ====== */
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=> t.style.display="none");
  $("#"+id).style.display = "block";
}

/* ====== Itens dinâmicos ====== */
function addItemRow(){
  const tb = $("#tblItens tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select class="tipo" style="padding:8px;width:120px">
        <option value="caixa">Caixa</option>
        <option value="saco">Saco</option>
      </select>
    </td>
    <td>
      <select class="tam" style="padding:8px;width:90px">
        <option value="p">P</option>
        <option value="m">M</option>
        <option value="g">G</option>
      </select>
    </td>
    <td>
      <input type="number" min="0" class="qtd" value="1" style="padding:8px;width:100px">
    </td>
    <td class="right">
      <button class="btn btn-sm" type="button" onclick="this.closest('tr').remove(); calcTotal()">Remover</button>
    </td>`;
  tb.appendChild(tr);
  calcTotal();
}
function calcTotal(){
  let tot=0;
  document.querySelectorAll("#tblItens .qtd").forEach(i=> tot += Number(i.value||0));
  $("#rom_total").textContent = tot;
}
document.addEventListener("input", (e)=>{ if (e.target.classList.contains("qtd")) calcTotal(); });
document.addEventListener("DOMContentLoaded", ()=> addItemRow());

/* ====== fotos para base64 ====== */
function filesToBase64(input){
  const files = Array.from(input.files||[]);
  return Promise.all(files.map(f => new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res({ name:f.name, data:r.result });
    r.readAsDataURL(f);
  })));
}

/* ====== enviar romaneio ====== */
async function enviarRomaneio(){
  const s = sess();
  if(!s?.token){ toast("Sessão expirada. Faça login.", "err"); location.replace("index.html"); return; }

  try{
    const itens = Array.from(document.querySelectorAll("#tblItens tbody tr")).map(tr=>({
      tipo: tr.querySelector(".tipo").value,
      tamanho: tr.querySelector(".tam").value,
      qtd: Number(tr.querySelector(".qtd").value||0)
    })).filter(i=>i.qtd>0);

    const fotos = await filesToBase64($("#rom_fotos"));

    const body = {
      rom: $("#rom_rom").value,
      data: $("#rom_data").value,
      obs : $("#rom_obs").value,
      cliente: { tel: $("#cli_tel").value, nome: $("#cli_nome").value, local: $("#cli_loc").value },
      fornecedor: { tel: $("#for_tel").value, nome: $("#for_nome").value, local: $("#for_loc").value },
      itens, fotos,
      token: s.token
    };

    setLoading(true);
    const res = await fetch(API_BASE+"?path=rom/create", {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(body),
      cache:"no-store"
    });
    setLoading(false);

    if(!res.ok){ toast("Falha (HTTP "+res.status+").", "err"); return; }
    const r = await res.json();
    if (r.error){ toast(r.error, "err"); return; }

    $("#rom_result").innerHTML = `
      <div><b>Romaneio criado!</b></div>
      <div>Código: <b>${r.cod}</b></div>
      <div><a href="${r.pdfUrl}" target="_blank">Abrir PDF</a></div>
      <div><a href="${r.whatsappUrl}" target="_blank">WhatsApp do cliente</a></div>`;
    toast("Enviado com sucesso.", "ok");
  }catch(err){
    setLoading(false);
    toast("Erro: "+(err?.message||err), "err");
  }
}

/* ====== sair ====== */
function logout(){
  localStorage.removeItem("session");
  location.replace("index.html");
}
</script>
</body>
</html>
