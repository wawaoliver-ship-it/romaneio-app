<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio ‚Ä¢ Painel</title>
  <meta name="theme-color" content="#0d1117" />
  <style>
    :root{
      --bg:#0d1117;--panel:#0f172a;--text:#e6edf3;--muted:#8a94a6;--primary:#2563eb;--ok:#16a34a;--err:#ef4444;--border:#1f2a44
      ;--chip:#1f2a44
    }
    [data-theme="light"]{
      --bg:#f7f7fb;--panel:#ffffff;--text:#0b1020;--muted:#56617a;--primary:#2563eb;--ok:#15803d;--err:#dc2626;--border:#e5e7eb;--chip:#eef2ff
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{position:sticky;top:0;z-index:5;padding:.75rem 1rem;background:var(--panel);border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center}
    .brand{font-weight:800}
    nav{display:flex;flex-wrap:wrap;gap:6px;margin-left:auto}
    nav button{padding:.55rem .8rem;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;cursor:pointer;font-weight:600}
    nav button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    nav .chip{background:var(--chip);border:1px solid var(--border);padding:.3rem .55rem;border-radius:999px;font-size:.85rem}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
    h2{margin:6px 0 10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem .75rem;border-bottom:1px solid var(--border);text-align:left}
    th{background:rgba(0,0,0,.06)}
    input,select,textarea{width:100%;padding:.65rem;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.g2,.g3,.g4{grid-template-columns:1fr}}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:.65rem 1rem;border:1px solid var(--primary);background:var(--primary);color:#fff;border-radius:10px;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .muted{color:var(--muted);font-size:.9rem}
    .status{margin-top:10px;height:36px;border-radius:8px;display:flex;align-items:center;padding:0 10px;font-weight:600}
    .ok{background:rgba(22,163,74,.12);color:var(--ok);border:1px solid rgba(22,163,74,.4)}
    .err{background:rgba(239,68,68,.12);color:var(--err);border:1px solid rgba(239,68,68,.4)}
    .progress{height:6px;background:linear-gradient(90deg,var(--primary),transparent);border-radius:999px;animation:load 1.2s linear infinite;margin:8px 0}
    @keyframes load{from{background-position-x:0}to{background-position-x:200%}}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:520px;width:100%}
    .ticket{border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:8px}
    canvas{max-width:100%;border:1px solid var(--border);border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">üöö <b>Romaneio</b></div>
    <span id="userChip" class="chip"></span>
    <nav>
      <button class="primary" onclick="showTab('rom')">Enviar Romaneio</button>
      <button class="ghost" onclick="showTab('clientes')">Clientes</button>
      <button class="ghost" onclick="showTab('roms')">Romaneios</button>
      <button class="ghost" onclick="showTab('fin')">Financeiro</button>
      <button class="ghost" onclick="toggleTheme()">üåô/‚òÄÔ∏è</button>
      <button class="ghost" onclick="logout()">Sair</button>
    </nav>
  </header>

  <main>
    <!-- TAB: Romaneio -->
    <section id="tab-rom" class="card">
      <h2>Enviar Romaneio</h2>
      <div class="grid g4">
        <label>ROM <input id="rom_rom" type="number" placeholder="Ex.: 21" /></label>
        <label>Data <input id="rom_data" type="date" /></label>
        <label>Observa√ß√µes <input id="rom_obs" placeholder="Ex.: Doca 3, at√© 16h" /></label>
        <div></div>
      </div>

      <h3>Cliente</h3>
      <div class="grid g3">
        <label>Telefone <input id="cli_tel" placeholder="85999999999" /></label>
        <label>Nome <input id="cli_nome" placeholder="Nome do cliente" /></label>
        <label>Cidade/UF <input id="cli_loc" placeholder="Fortaleza/CE" /></label>
      </div>

      <h3>Fornecedor</h3>
      <div class="grid g3">
        <label>Telefone <input id="for_tel" placeholder="85988888888" /></label>
        <label>Nome <input id="for_nome" placeholder="Nome do fornecedor" /></label>
        <label>Cidade/UF <input id="for_loc" placeholder="Maracana√∫/CE" /></label>
      </div>

      <h3>Itens</h3>
      <table id="tblItens">
        <thead><tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="ghost" type="button" onclick="addItemRow()">+ Item</button>
      <div class="row"><b>Total:</b> <span id="rom_total">0</span></div>

      <h3>Fotos</h3>
      <input id="rom_fotos" type="file" accept="image/*" multiple capture="environment" />
      <div class="muted">Voc√™ pode selecionar m√∫ltiplas imagens.</div>

      <div class="progress" id="progress" style="display:none"></div>
      <div id="status" class="status" style="display:none"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="enviarRomaneio()">Enviar</button>
        <button class="ghost" onclick="limparForm()">Limpar</button>
      </div>
    </section>

    <!-- Outras tabs (placeholders) -->
    <section id="tab-clientes" class="card" style="display:none"><h2>Clientes</h2><div class="muted">Em breve‚Ä¶</div></section>
    <section id="tab-roms" class="card" style="display:none"><h2>Romaneios</h2><div class="muted">Em breve‚Ä¶</div></section>
    <section id="tab-fin" class="card" style="display:none"><h2>Financeiro</h2><div class="muted">Em breve‚Ä¶</div></section>
  </main>

  <!-- Modal comprovante -->
  <div class="modal" id="modal">
    <div class="box">
      <h3>Romaneio criado ‚úÖ</h3>
      <div class="ticket">
        <div><b>C√≥digo:</b> <span id="m_cod"></span></div>
        <div><b>ROM:</b> <span id="m_rom"></span> ‚Ä¢ <b>Data:</b> <span id="m_data"></span></div>
        <div><b>Cliente:</b> <span id="m_cli"></span></div>
        <div><b>Total:</b> <span id="m_tot"></span></div>
      </div>
      <canvas id="ticketCanvas" width="600" height="360"></canvas>
      <div class="row" style="margin-top:10px">
        <a id="m_pdf" class="btn" target="_blank">Abrir PDF</a>
        <a id="m_wa"  class="ghost" target="_blank">WhatsApp</a>
        <a id="m_img" class="ghost" download>Baixar imagem</a>
        <button class="ghost" onclick="closeModal()">Fechar</button>
      </div>
    </div>
  </div>

<script>
const APP_VERSION = "v2025-08-28-1";
// Tema
function toggleTheme(){
  const root = document.documentElement;
  const cur = root.getAttribute("data-theme") || "dark";
  const next = cur === "dark" ? "light" : "dark";
  root.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
}
(function bootTheme(){
  const saved = localStorage.getItem("theme");
  if (saved) document.documentElement.setAttribute("data-theme", saved);
})();

// Guard de sess√£o (sem loop)
(function guard(){
  const s = JSON.parse(localStorage.getItem("session")||"null");
  if (!s || !s.token) {
    location.replace("index.html?v=" + Date.now());
  } else {
    document.getElementById("userChip").textContent = (s.usuario || s.nome || "Usu√°rio");
  }
})();

const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec";

function showTab(id){
  ["rom","clientes","roms","fin"].forEach(t=>{
    document.getElementById("tab-"+t).style.display = (t===id) ? "block" : "none";
  });
}
showTab("rom");

// Data hoje auto
(function setToday(){
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  document.getElementById("rom_data").value = iso;
})();

function logout(){
  try {
    const s = JSON.parse(localStorage.getItem("session")||"null");
    // opcional chamar /logout
    fetch(API_BASE+"?path=/logout&nocache="+Date.now(), {
      method:"POST", headers:{ "Content-Type":"text/plain" },
      body: JSON.stringify({ token: s?.token })
    }).catch(()=>{});
  } finally {
    localStorage.clear(); sessionStorage.clear();
    location.href = "index.html?v=" + Date.now();
  }
}

function $(sel){ return document.querySelector(sel); }
function addItemRow(pref={}){
  const tb = $("#tblItens tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><select class="tipo"><option value="caixa"${pref.tipo==="caixa"?" selected":""}>Caixa</option><option value="saco"${pref.tipo==="saco"?" selected":""}>Saco</option></select></td>
    <td><select class="tam"><option value="p"${pref.tamanho==="p"?" selected":""}>P</option><option value="m"${pref.tamanho==="m"?" selected":""}>M</option><option value="g"${pref.tamanho==="g"?" selected":""}>G</option></select></td>
    <td><input type="number" min="0" class="qtd" value="${pref.qtd||0}"></td>
    <td><button class="ghost" type="button" onclick="this.closest('tr').remove(); calcTotal()">x</button></td>`;
  tb.appendChild(tr); calcTotal();
}
function calcTotal(){
  let tot=0; document.querySelectorAll("#tblItens .qtd").forEach(i=> tot += Number(i.value||0));
  $("#rom_total").textContent = tot;
}
document.addEventListener("input", (e)=>{ if(e.target.classList.contains("qtd")) calcTotal(); });
addItemRow();

function filesToBase64(input){
  const files = Array.from(input.files||[]);
  return Promise.all(files.map(f => new Promise(res=>{
    const r=new FileReader(); r.onload=()=>res({ name:f.name, data:r.result }); r.readAsDataURL(f);
  })));
}

function showStatus(kind,msg){ const s=$("#status"); s.className="status "+(kind||""); s.textContent=msg; s.style.display="flex"; }
function showProgress(on){ $("#progress").style.display = on ? "block" : "none"; }

function limparForm(){
  $("#rom_obs").value="";
  $("#cli_tel").value=""; $("#cli_nome").value=""; $("#cli_loc").value="";
  $("#for_tel").value=""; $("#for_nome").value=""; $("#for_loc").value="";
  $("#tblItens tbody").innerHTML=""; addItemRow(); $("#rom_total").textContent="0";
  $("#rom_fotos").value="";
}

async function api(path, body={}){
  const s = JSON.parse(localStorage.getItem("session")||"null");
  const url = API_BASE + "?path=" + encodeURIComponent(path) + "&nocache=" + Date.now();
  const res = await fetch(url,{
    method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ ...body, token: s?.token })
  });
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

function drawTicketPNG({cod, rom, data, cliNome, total}){
  const c = document.getElementById("ticketCanvas");
  const ctx = c.getContext("2d");
  // bg
  ctx.fillStyle = (document.documentElement.getAttribute("data-theme")==="light") ? "#ffffff" : "#0f172a";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle = (document.documentElement.getAttribute("data-theme")==="light") ? "#0b1020" : "#e6edf3";
  ctx.font = "bold 22px system-ui";
  ctx.fillText("Comprovante de Romaneio", 20, 40);
  ctx.font = "16px system-ui";
  ctx.fillText("C√≥digo: "+cod, 20, 80);
  ctx.fillText("ROM: "+rom, 20, 110);
  ctx.fillText("Data: "+data, 20, 140);
  ctx.fillText("Cliente: "+cliNome, 20, 170);
  ctx.fillText("Total de volumes: "+total, 20, 200);
  // ‚Äúdestacar‚Äù c√≥digo
  ctx.strokeStyle = "#2563eb"; ctx.lineWidth=2;
  ctx.strokeRect(16,60, c.width-32,28);
  const url = c.toDataURL("image/png");
  const a = document.getElementById("m_img");
  a.href = url; a.download = "ROM_"+cod+".png";
}

function openModal(dados){
  $("#m_cod").textContent = dados.cod;
  $("#m_rom").textContent = dados.rom;
  $("#m_data").textContent = dados.data;
  $("#m_cli").textContent = dados.cliNome;
  $("#m_tot").textContent = dados.total;
  $("#m_pdf").href = dados.pdfUrl;
  $("#m_wa").href  = dados.whatsappUrl;
  drawTicketPNG(dados);
  $("#modal").style.display = "flex";
}
function closeModal(){ $("#modal").style.display = "none"; }

async function enviarRomaneio(){
  try{
    showProgress(true); showStatus("",""); $("#status").style.display="none";

    const itens = Array.from(document.querySelectorAll("#tblItens tbody tr")).map(tr=>({
      tipo: tr.querySelector(".tipo").value,
      tamanho: tr.querySelector(".tam").value,
      qtd: Number(tr.querySelector(".qtd").value||0)
    })).filter(i=>i.qtd>0);
    if(!itens.length){ showStatus("err","Inclua pelo menos 1 item."); showProgress(false); return; }

    const fotos = await filesToBase64($("#rom_fotos"));

    const body = {
      rom: $("#rom_rom").value,
      data: $("#rom_data").value,
      obs : $("#rom_obs").value,
      cliente: { tel: $("#cli_tel").value, nome: $("#cli_nome").value, local: $("#cli_loc").value },
      fornecedor: { tel: $("#for_tel").value, nome: $("#for_nome").value, local: $("#for_loc").value },
      itens, fotos
    };

    const r = await api("/rom/create", body);
    if (r.error){ showStatus("err", r.error); showProgress(false); return; }

    showStatus("ok","Romaneio enviado!");
    // limpa formul√°rio
    limparForm();

    // abre modal comprovante
    const dataIso = $("#rom_data").value || new Date().toISOString().slice(0,10);
    openModal({
      cod: r.cod, rom: body.rom||"", data: dataIso,
      cliNome: body.cliente?.nome||"", total: document.getElementById("rom_total").textContent,
      pdfUrl: r.pdfUrl, whatsappUrl: r.whatsappUrl
    });

  }catch(err){
    showStatus("err", "Erro: " + err.message);
  }finally{
    showProgress(false);
  }
}
</script>
</body>
</html>
