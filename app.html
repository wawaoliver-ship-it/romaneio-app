<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Romaneio ‚Ä¢ Painel</title>
<meta name="theme-color" content="#0d1117"/>
<style>
  :root{
    --bg:#0d1117;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
    --primary:#2563eb;--border:#1f2a44;--ok:#16a34a;--bad:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
  header{padding:.75rem;background:#0b0f1a;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h2{margin:12px 0 8px;border-bottom:1px solid var(--border);padding-bottom:6px}
  label{display:block;margin:8px 0;font-size:14px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
    background:#0b1220;color:var(--text)}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:.6rem 1rem;border:0;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.muted{background:#15223c;color:#fff}
  .btn.bad{background:var(--bad);color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:.55rem .65rem;border-bottom:1px solid var(--border);text-align:left}
  th{background:#111827}
  .note{font-size:12px;color:var(--muted)}
  .badge{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
    padding:.5rem .75rem;border-radius:10px;background:#111827;border:1px solid var(--border)}
  .badge.ok{color:#d1fae5;border-color:#064e3b}
  .badge.err{color:#fee2e2;border-color:#7f1d1d}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  .mini{font-size:12px;color:var(--muted)}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap}
  .thumbs img{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
  nav a{margin-left:10px;color:var(--muted);text-decoration:none;font-weight:600}
  nav a:hover{color:#fff}
</style>
</head>
<body>
<header>
  <div>üöö <b>Romaneio</b></div>
  <nav>
    <a href="#" id="btnTest">Testar API</a>
  </nav>
</header>

<main class="wrap">

  <div class="card">
    <h2>Enviar Romaneio</h2>

    <div class="grid">
      <label>ROM
        <input id="rom_rom" type="number" placeholder="Ex.: 21"/>
      </label>
      <label>Data
        <input id="rom_data" type="date"/>
      </label>
      <label>Observa√ß√µes
        <input id="rom_obs" placeholder="Ex.: Doca 3, √†s 16h"/>
      </label>
    </div>

    <h3>Cliente</h3>
    <div class="grid">
      <label>Telefone <input id="cli_tel" placeholder="85999999999"/></label>
      <label>Nome <input id="cli_nome" placeholder="Nome do cliente"/></label>
      <label>Cidade/UF <input id="cli_loc" placeholder="Fortaleza/CE"/></label>
    </div>

    <h3>Fornecedor (opcional)</h3>
    <div class="grid">
      <label>Telefone <input id="for_tel" placeholder="85999999999"/></label>
      <label>Nome <input id="for_nome" placeholder="Nome do fornecedor"/></label>
      <label>Cidade/UF <input id="for_loc" placeholder="Maracana√∫/CE"/></label>
    </div>

    <h3>Itens</h3>
    <table id="tblItens">
      <thead><tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button class="btn muted" id="addItem">+ Item</button>
      <div class="mini">Total: <b id="rom_total">0</b></div>
    </div>

    <h3>Fotos</h3>
    <input id="rom_fotos" type="file" accept="image/*" multiple/>
    <div class="mini">Voc√™ pode selecionar v√°rias imagens. Pr√©-visualiza√ß√£o abaixo.</div>
    <div id="thumbs" class="thumbs" style="margin-top:8px"></div>

    <div class="row" style="margin-top:14px">
      <button class="btn primary" id="btnEnviar">Enviar</button>
      <button class="btn" id="btnLimpar">Limpar</button>
    </div>

    <div id="out" class="mini" style="margin-top:10px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Diagn√≥stico r√°pido</h3>
    <div class="mini">Mostra o que o servidor recebeu em <code>/echo</code>.</div>
    <pre id="diag" class="mini" style="white-space:pre-wrap;background:#0b1220;border:1px solid var(--border);padding:10px;border-radius:8px;margin-top:8px"></pre>
  </div>

</main>

<div id="badge" class="badge" style="display:none"></div>

<script>
/* ========= CONFIG ========= */
// COLE AQUI sua URL /exec (a mais recente ap√≥s "Implantar")
const API_BASE = "https://script.google.com/macros/s/AKfycbwQI7qWHBqRRbLs6lzF13-t2Fi3V7bDTpatRbqSsLk/dev";

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
function showBadge(msg, ok=false){
  const el = $('#badge'); el.textContent = msg; el.className = 'badge ' + (ok?'ok':'err');
  el.style.display='block'; setTimeout(()=> el.style.display='none', 3500);
}
function sess(){
  try { return JSON.parse(localStorage.getItem('session')) || null; } catch(_){ return null; }
}
function todayStr(){
  const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${m}-${day}`;
}
function ensurePath(p){ p=String(p||'/'); return p.startsWith('/')?p:('/'+p); }

/* ========= API ========= */
async function api(path, body = {}){
  path = ensurePath(path);
  const s = sess();
  const url = API_BASE + '?path=' + encodeURIComponent(path);
  const res = await fetch(url, {
    method:'POST',
    headers:{ 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ token:s?.token, ...body }),
    cache:'no-store',
    redirect:'follow'
  });
  let dataText = await res.text(); 
  let data; try { data = JSON.parse(dataText); } catch(_){ data = { raw:dataText }; }
  return data;
}

/* ========= UI: Itens ========= */
function addItemRow(tipo='caixa', tam='p', qtd=1){
  const tb = $('#tblItens tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <select class="tipo">
        <option value="caixa"${tipo==='caixa'?' selected':''}>Caixa</option>
        <option value="saco"${tipo==='saco'?' selected':''}>Saco</option>
      </select>
    </td>
    <td>
      <select class="tam">
        <option value="p"${tam==='p'?' selected':''}>P</option>
        <option value="m"${tam==='m'?' selected':''}>M</option>
        <option value="g"${tam==='g'?' selected':''}>G</option>
      </select>
    </td>
    <td><input type="number" class="qtd" min="0" value="${qtd}"/></td>
    <td><button type="button" class="btn bad btnDel">Remover</button></td>`;
  tb.appendChild(tr);
  calcTotal();
}
function calcTotal(){
  let tot=0;
  document.querySelectorAll('#tblItens .qtd').forEach(i=> tot += Number(i.value||0));
  $('#rom_total').textContent = tot;
}
document.addEventListener('input', e => { if(e.target.classList.contains('qtd')) calcTotal(); });
document.addEventListener('click', e=>{
  if(e.target.id==='addItem') addItemRow();
  if(e.target.classList.contains('btnDel')) { e.target.closest('tr').remove(); calcTotal(); }
});

/* ========= Fotos preview ========= */
$('#rom_fotos').addEventListener('change', ()=>{
  const cont = $('#thumbs'); cont.innerHTML='';
  const files = Array.from($('#rom_fotos').files||[]);
  files.forEach(f=>{
    const r = new FileReader();
    r.onload = ()=> {
      const img = new Image(); img.src = r.result; 
      cont.appendChild(img);
    };
    r.readAsDataURL(f);
  });
});

/* ========= Enviar ========= */
async function filesToBase64(input){
  const files = Array.from(input.files||[]);
  const arr = await Promise.all(files.map(f => new Promise(res=>{
    const r = new FileReader(); r.onload = ()=> res({ name:f.name, data:r.result }); r.readAsDataURL(f);
  })));
  return arr;
}

async function enviar(){
  try{
    const itens = Array.from(document.querySelectorAll('#tblItens tbody tr')).map(tr=>({
      tipo: tr.querySelector('.tipo').value,
      tamanho: tr.querySelector('.tam').value,
      qtd: Number(tr.querySelector('.qtd').value||0)
    })).filter(i=> i.qtd>0);

    const fotos = await filesToBase64($('#rom_fotos'));

    const body = {
      rom: $('#rom_rom').value,
      data: $('#rom_data').value,
      obs : $('#rom_obs').value,
      cliente: { tel: $('#cli_tel').value, nome: $('#cli_nome').value, local: $('#cli_loc').value },
      fornecedor: { tel: $('#for_tel').value, nome: $('#for_nome').value, local: $('#for_loc').value },
      itens, fotos
    };

    $('#out').textContent = 'Enviando...';
    const r = await api('/rom/create', body);
    $('#out').textContent = JSON.stringify(r, null, 2);

    if(r.error){ showBadge('Erro: '+r.error,false); return; }
    showBadge('Romaneio criado! COD '+r.cod, true);

  }catch(err){
    $('#out').textContent = 'Falha: '+err.message;
    showBadge('Falha: '+err.message, false);
  }
}

/* ========= Diagn√≥stico /echo ========= */
async function testarEcho(){
  const payload = { foo:'bar', momento: new Date().toISOString() };
  const r = await api('/echo', payload);
  $('#diag').textContent = JSON.stringify(r, null, 2);
  if(r && (r.ok||r.pong!==undefined)) showBadge('Echo OK', true);
  else showBadge('Echo falhou', false);
}

/* ========= Inicializa√ß√£o ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#rom_data').value = todayStr();
  addItemRow();
  $('#btnEnviar').addEventListener('click', enviar);
  $('#btnLimpar').addEventListener('click', ()=> location.reload());
  $('#btnTest').addEventListener('click', (e)=>{ e.preventDefault(); testarEcho(); });
});
</script>
</body>
</html>
