<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Romaneio • Painel</title>
  <meta name="theme-color" content="#0d1117"/>
  <link rel="icon" href="icon-192.png"/>

  <style>
    :root{
      --bg:#0d1117;--panel:#0f172a;--muted:#9aa5b1;--text:#e6edf3;
      --primary:#2563eb;--border:#1f2a44;--danger:#ef4444;--ok:#22c55e;
      --chip:#0b1223;
    }
    /* layout base */
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    header{padding:.75rem 1rem;background:#0b0f1a;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:14px}
    .brand{font-weight:700}
    nav{margin-left:auto;display:flex;gap:16px}
    nav a{color:var(--muted);text-decoration:none;font-weight:600}
    nav a.active,nav a:hover{color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h2{margin:18px 0 10px;border-bottom:1px solid var(--border);padding-bottom:6px}
    section.tab{display:none}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
      background:#0b1223;color:#e6edf3;outline:none}
    textarea{resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.65rem .75rem;border-bottom:1px solid var(--border);text-align:left}
    th{background:#0b1223;color:#cbd5e1}
    .btn{padding:.55rem 1rem;border:0;border-radius:8px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-muted{background:#122036;color:#cbd5e1}
    .btn-danger{background:var(--danger);color:#fff}
    .chip{background:var(--chip);border:1px solid var(--border);padding:.35rem .6rem;border-radius:999px;font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    /* top loader */
    #loader{position:fixed;left:0;top:0;height:3px;background:var(--primary);width:0%;z-index:9999;transition:width .25s ease}
    /* toast */
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:#111827;color:#e5e7eb;
      border:1px solid var(--border);padding:.6rem .9rem;border-radius:8px;display:none;z-index:9999}
    #toast.ok{border-color:#14532d;background:#052e16;color:#a7f3d0}
    #toast.err{border-color:#7f1d1d;background:#2a0c0c;color:#fecaca}
    /* empty state */
    .empty{padding:30px;text-align:center;color:var(--muted)}
    /* small */
    @media (max-width:900px){.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <!-- loader + toast -->
  <div id="loader"></div>
  <div id="toast"></div>

  <header>
    <div class="brand">🚚 Romaneio</div>
    <nav id="menu">
      <a href="#rom" data-tab="rom">Enviar Romaneio</a>
      <a href="#romaneios" data-tab="romaneios">Romaneios</a>
      <a href="#clientes" data-tab="clientes">Clientes</a>
      <a href="#financeiro" data-tab="financeiro">Financeiro</a>
      <a href="#users" data-tab="users">Usuários</a>
      <a href="#" id="btnSair">Sair</a>
    </nav>
  </header>

  <main class="wrap">

    <!-- ROM (form) -->
    <section id="tab-rom" class="tab">
      <h2>Enviar Romaneio</h2>
      <div class="card">
        <div class="grid-3">
          <div><label>ROM</label><input id="rom_rom" type="number" placeholder="Ex: 21"></div>
          <div><label>Data</label><input id="rom_data" type="date"></div>
          <div><label>Observações</label><textarea id="rom_obs" rows="2" placeholder="Ex.: Agendar com o cliente"></textarea></div>
        </div>

        <h3 style="margin-top:16px">Cliente</h3>
        <div class="grid-3">
          <div><label>Telefone</label><input id="cli_tel" placeholder="(DDD) 90000-0000"></div>
          <div><label>Nome</label><input id="cli_nome" placeholder="Nome do cliente"></div>
          <div><label>Cidade/UF</label><input id="cli_loc" placeholder="Fortaleza/CE"></div>
        </div>

        <div class="row" style="margin:6px 0 10px">
          <button class="btn btn-muted" id="btnFillCli">Preencher pelo telefone</button>
          <span class="chip">Fornecedor <b>Opcional</b></span>
        </div>

        <div class="grid-3">
          <div><label>Telefone</label><input id="for_tel" placeholder="(DDD) 90000-0000"></div>
          <div><label>Nome</label><input id="for_nome" placeholder="Nome do fornecedor"></div>
          <div><label>Cidade/UF</label><input id="for_loc" placeholder="Maracanaú/CE"></div>
        </div>

        <h3 style="margin-top:16px">Itens</h3>
        <div class="row" style="margin-bottom:6px">
          <button class="btn btn-muted" id="btnAddItem">+ Item</button>
          <div class="right"><b>Total: <span id="rom_total">0</span></b></div>
        </div>
        <table id="tblItens">
          <thead><tr><th>Tipo</th><th>Tamanho</th><th>Qtd</th><th></th></tr></thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px">Fotos</h3>
        <input id="rom_fotos" type="file" accept="image/*" multiple capture="environment">
        <div style="margin:6px 0 12px;color:var(--muted);font-size:12px">Você pode escolher várias e remover antes de enviar.</div>

        <div class="row">
          <button id="btnEnviarRom" class="btn btn-primary">Enviar Romaneio</button>
        </div>

        <div id="rom_result" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Romaneios -->
    <section id="tab-romaneios" class="tab">
      <h2>Romaneios</h2>
      <div class="card">
        <div class="row"><button id="btnLoadRom" class="btn btn-muted">🔄 Atualizar</button></div>
        <div id="listRom" class="empty">Sem registros por enquanto.</div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="tab-clientes" class="tab">
      <h2>Clientes</h2>
      <div class="card">
        <div class="row"><button id="btnLoadCli" class="btn btn-muted">🔄 Atualizar</button></div>
        <div id="listCli" class="empty">Sem registros por enquanto.</div>
      </div>
    </section>

    <!-- Financeiro -->
    <section id="tab-financeiro" class="tab">
      <h2>Financeiro</h2>
      <div class="card">
        <div class="empty">Em breve.</div>
      </div>
    </section>

    <!-- Usuários -->
    <section id="tab-users" class="tab">
      <h2>Usuários</h2>
      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <button id="btnNewUser" class="btn btn-primary">+ Novo usuário</button>
        </div>

        <table id="tblUsers" style="display:none">
          <thead>
          <tr>
            <th>Usuário</th><th>Nome</th><th>Ativo</th><th>Permissões</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="usersEmpty" class="empty">Sem usuários.</div>
      </div>
    </section>

  </main>

  <!-- ======== SCRIPTS ======== -->
  <script>
    /* ===== CONFIG ===== */
    const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec";
    const PERM_ALL = "*";

    /* ===== helpers UI ===== */
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const toast = (msg, kind="")=>{
      const el=$("#toast");
      el.textContent=msg; el.className=kind?kind:"";
      el.style.display="block";
      clearTimeout(el._t); el._t=setTimeout(()=>el.style.display="none", 3000);
    };
    const loader = {
      on(){ $("#loader").style.width="55%"; },
      progress(p){ $("#loader").style.width = (p||90)+"%"; },
      off(){ $("#loader").style.width="100%"; setTimeout(()=>$("#loader").style.width="0%", 220); }
    };

    /* ===== session ===== */
    function sess(){
      try{ return JSON.parse(localStorage.getItem("session")||"null"); }catch(_){ return null; }
    }
    function requireLogin(){
      const s = sess();
      if(!s || !s.token){ location.href="index.html"; return false; }
      return true;
    }
    function hasPerm(p){
      const s = sess();
      const perms = (s && Array.isArray(s.perms) ? s.perms : [PERM_ALL]);
      return perms.includes(PERM_ALL) || perms.includes(p);
    }

    /* ===== API ===== */
    async function api(path, body={}){
      const s = sess();
      const url = API_BASE + "?path=" + encodeURIComponent(path);
      const res = await fetch(url,{
        method:"POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify({...body, token: s?.token}),
        cache:"no-store"
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      return res.json();
    }

    /* ===== Router & permissions ===== */
    const tabs = {
      rom      : { el: "#tab-rom",         perm: "rom" },
      romaneios: { el: "#tab-romaneios",   perm: "romaneios" },
      clientes : { el: "#tab-clientes",    perm: "clientes" },
      financeiro:{ el:"#tab-financeiro",   perm: "financeiro" },
      users    : { el: "#tab-users",       perm: "usuarios" },
    };

    function setActiveMenu(hash){
      $$("#menu a[data-tab]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("data-tab")===hash);
      });
    }

    async function showTabFromHash(){
      if(!requireLogin()) return;
      const hash = (location.hash.replace("#","") || "rom");
      const def  = tabs[hash] || tabs.rom;

      // permissões
      if(!hasPerm(def.perm)){
        toast("Você não tem acesso a esta área.","err");
        location.hash = Object.keys(tabs).find(k=>hasPerm(tabs[k].perm)) || "rom";
        return;
      }

      // esconde/mostra
      $$(".tab").forEach(s=>s.style.display="none");
      $(def.el).style.display="block";
      setActiveMenu(hash);

      // carregamentos rápidos por aba
      if(hash==="users")      loadUsers();
      if(hash==="romaneios")  loadRomaneios();
      if(hash==="clientes")   loadClientes();
    }

    window.addEventListener("hashchange", showTabFromHash);

    /* ===== menu sair ===== */
    $("#btnSair").addEventListener("click", async (e)=>{
      e.preventDefault();
      try{ await api("/logout"); }catch(_){}
      localStorage.removeItem("session");
      // tentar limpar storage do app
      try{ localStorage.clear(); sessionStorage.clear(); caches && caches.keys().then(ks=>ks.forEach(k=>caches.delete(k))); }catch(_){}
      location.href="index.html";
    });

    /* ===== ROM (form) ===== */
    function addItemRow(tipo="caixa", tam="p", qtd=1){
      const tb = $("#tblItens tbody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <select class="tipo">
            <option value="caixa"${tipo==="caixa"?" selected":""}>Caixa</option>
            <option value="saco"${tipo==="saco"?" selected":""}>Saco</option>
          </select>
        </td>
        <td>
          <select class="tam">
            <option value="p"${tam==="p"?" selected":""}>P</option>
            <option value="m"${tam==="m"?" selected":""}>M</option>
            <option value="g"${tam==="g"?" selected":""}>G</option>
          </select>
        </td>
        <td><input type="number" min="0" class="qtd" value="${qtd}"></td>
        <td><button class="btn btn-danger btn-xs">Remover</button></td>
      `;
      tr.querySelector(".btn").addEventListener("click", ()=>{ tr.remove(); calcTotal(); });
      tr.querySelector(".qtd").addEventListener("input", calcTotal);
      tb.appendChild(tr);
      calcTotal();
    }
    function calcTotal(){
      let tot=0; $$("#tblItens .qtd").forEach(i=> tot += Number(i.value||0));
      $("#rom_total").textContent = tot;
    }
    $("#btnAddItem").addEventListener("click", ()=> addItemRow());

    async function filesToBase64(input){
      const files = Array.from(input.files||[]);
      return Promise.all(files.map(f => new Promise(res=>{
        const r=new FileReader(); r.onload=()=>res({ name:f.name, data:r.result }); r.readAsDataURL(f);
      })));
    }

    function clearRomForm(){
      $("#rom_rom").value = "";
      $("#rom_data").value = "";
      $("#rom_obs").value  = "";
      $("#cli_tel").value = $("#cli_nome").value = $("#cli_loc").value = "";
      $("#for_tel").value = $("#for_nome").value = $("#for_loc").value = "";
      $("#rom_fotos").value = "";
      $("#tblItens tbody").innerHTML = "";
      addItemRow();
      $("#rom_result").innerHTML = "";
      calcTotal();
    }

    $("#btnEnviarRom").addEventListener("click", async ()=>{
      try{
        loader.on();
        const itens = $$("#tblItens tbody tr").map(tr=>({
          tipo: tr.querySelector(".tipo").value,
          tamanho: tr.querySelector(".tam").value,
          qtd: Number(tr.querySelector(".qtd").value||0)
        })).filter(i=>i.qtd>0);
        if(!itens.length){ toast("Inclua ao menos 1 item.","err"); return; }

        const fotos = await filesToBase64($("#rom_fotos"));

        const body = {
          rom: $("#rom_rom").value,
          data: $("#rom_data").value,
          obs : $("#rom_obs").value,
          cliente: { tel: $("#cli_tel").value, nome: $("#cli_nome").value, local: $("#cli_loc").value },
          fornecedor: { tel: $("#for_tel").value, nome: $("#for_nome").value, local: $("#for_loc").value },
          itens, fotos
        };

        loader.progress();
        const r = await api("/rom/create", body);
        loader.off();

        if(r.error){ toast(r.error,"err"); return; }

        $("#rom_result").innerHTML = `
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <span class="chip">Romaneio criado</span>
            <span class="chip">Código: <b>${r.cod}</b></span>
            ${r.pdfUrl?`<a class="btn btn-muted" target="_blank" href="${r.pdfUrl}">Abrir PDF</a>`:""}
            ${r.whatsappUrl?`<a class="btn btn-primary" target="_blank" href="${r.whatsappUrl}">WhatsApp do cliente</a>`:""}
          </div>
        `;
        toast("Romaneio enviado!","ok");
        clearRomForm();
      }catch(err){
        loader.off();
        toast("Falha ao enviar: "+err.message,"err");
      }
    });

    // exemplo bobo para “preencher pelo tel” (lado cliente)
    $("#btnFillCli").addEventListener("click", ()=>{
      const t = $("#cli_tel").value.replace(/\D/g,"");
      if(!t){ toast("Informe o telefone do cliente.","err"); return; }
      $("#cli_nome").value = $("#cli_nome").value || "Cliente";
      $("#cli_loc").value  = $("#cli_loc").value  || "Fortaleza/CE";
    });

    /* ===== Listagens simples (placeholders) ===== */
    async function loadRomaneios(){
      $("#listRom").innerHTML = `<div class="empty">Carregando…</div>`;
      // (se quiser, crie no backend /rom/list)
      $("#listRom").innerHTML = `<div class="empty">Sem registros (crie um /rom/list no backend se quiser listar aqui 😉)</div>`;
    }
    async function loadClientes(){
      $("#listCli").innerHTML = `<div class="empty">Carregando…</div>`;
      $("#listCli").innerHTML = `<div class="empty">Sem registros (crie um /clientes no backend se quiser listar aqui 😉)</div>`;
    }

    /* ===== Usuários (lista + modal) ===== */
    function renderPermsChips(perms){
      if(!perms || !perms.length) return `<span class="chip">—</span>`;
      return perms.map(p=>`<span class="chip">${p}</span>`).join(" ");
    }

    async function loadUsers(){
      if(!hasPerm("usuarios")){
        $("#tab-users").innerHTML = `<div class="card"><div class="empty">Sem permissão.</div></div>`;
        return;
      }
      $("#usersEmpty").style.display="block";
      $("#tblUsers").style.display="none";
      try{
        loader.on();
        const r = await api("/users/list");
        loader.off();
        if(r.error){ toast(r.error,"err"); return; }
        const tb = $("#tblUsers tbody"); tb.innerHTML="";
        (r.users||[]).forEach(u=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${u.usuario}</td>
            <td>${u.nome||""}</td>
            <td>${u.ativo? "✅":"❌"}</td>
            <td>${renderPermsChips(u.perms||[])}</td>
            <td><button class="btn btn-muted btn-edit">Editar</button></td>
          `;
          tr.querySelector(".btn-edit").addEventListener("click",()=> openUserModal(u));
          tb.appendChild(tr);
        });
        if((r.users||[]).length){ $("#usersEmpty").style.display="none"; $("#tblUsers").style.display="table"; }
      }catch(err){
        loader.off(); toast(err.message,"err");
      }
    }

    function openUserModal(u){
      const allPerms = ["rom","romaneios","clientes","financeiro","usuarios"];
      const div = document.createElement("div");
      div.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998";
      div.innerHTML = `
        <div class="card" style="width:min(680px,92vw);max-height:90vh;overflow:auto">
          <h3>${u? "Editar usuário":"Novo usuário"}</h3>
          <div class="grid-2" style="margin-top:10px">
            <div><label>Usuário (login)</label><input id="u_usuario" ${u?"disabled":""} value="${u?.usuario||""}"></div>
            <div><label>Nome</label><input id="u_nome" value="${u?.nome||""}"></div>
          </div>
          <div class="grid-2" style="margin-top:10px">
            <div><label>Nova senha</label><input id="u_pwd1" type="password" placeholder="${u?"(deixe em branco p/ não alterar)":"Digite a senha"}"></div>
            <div><label>Repita a senha</label><input id="u_pwd2" type="password" placeholder="${u?"(deixe em branco p/ não alterar)":"Repita a senha"}"></div>
          </div>
          <div style="margin-top:12px">
            <label>Permissões</label>
            <div class="row" style="flex-wrap:wrap;gap:8px;margin-top:6px">
              ${allPerms.map(p=>{
                const on = (u?.perms||[]).includes(p) || (u && (u.perms||[]).includes("*"));
                return `<label class="chip" style="cursor:pointer">
                  <input class="perm" type="checkbox" value="${p}" ${on?"checked":""} style="margin-right:6px">${p}
                </label>`;
              }).join("")}
            </div>
          </div>
          <div class="row" style="margin-top:16px">
            <label class="row" style="gap:8px"><input id="u_ativo" type="checkbox" ${u?.ativo!==false?"checked":""}> Ativo</label>
            <div class="right">
              <button class="btn btn-muted" id="u_cancel">Cancelar</button>
              <button class="btn btn-primary" id="u_save">Salvar</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(div);
      $("#u_cancel",div).onclick=()=>div.remove();
      $("#u_save",div).onclick=async()=>{
        try{
          const usuario = $("#u_usuario",div).value.trim();
          const nome = $("#u_nome",div).value.trim();
          const pwd1 = $("#u_pwd1",div).value;
          const pwd2 = $("#u_pwd2",div).value;
          const ativo = $("#u_ativo",div).checked;
          const perms = $$(".perm",div).filter(i=>i.checked).map(i=>i.value);

          if(!usuario){ toast("Informe o usuário.","err"); return; }
          if(!u){ // novo -> senha obrigatória
            if(!pwd1 || !pwd2 || pwd1!==pwd2){ toast("Senhas não conferem.","err"); return; }
          }else{
            if((pwd1||pwd2) && pwd1!==pwd2){ toast("Senhas não conferem.","err"); return; }
          }

          loader.on();
          const r = await api("/users/upsert", { usuario, nome, senha: pwd1||"", ativo, perms });
          loader.off();
          if(r.error){ toast(r.error,"err"); return; }
          toast("Usuário salvo!","ok");
          div.remove();
          loadUsers();
        }catch(err){
          loader.off(); toast(err.message,"err");
        }
      };
    }
    $("#btnNewUser").addEventListener("click", ()=> openUserModal(null));

    /* ===== boot ===== */
    document.addEventListener("DOMContentLoaded", ()=>{
      if(!requireLogin()) return;
      // se não houver hash, define a primeira aba permitida
      const firstAllowed = Object.entries(tabs).find(([k,v])=>hasPerm(v.perm))?.[0] || "rom";
      if(!location.hash) location.hash = firstAllowed;
      // pelo menos 1 linha no ROM
      addItemRow();
      showTabFromHash();
    });
  </script>
</body>
</html>
