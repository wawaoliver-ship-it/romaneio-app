<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio • Painel</title>
  <meta name="theme-color" content="#0d1117" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />

  <!-- ========== GUARD DE SESSÃO ==========
       Esconde a página, valida o token com a API e só mostra se estiver ok.
       Caso contrário, limpa a sessão e volta para index.html               -->
  <script>
    document.documentElement.style.visibility = 'hidden';
    (async () => {
      const API_BASE = "https://script.google.com/macros/s/AKfycbwJwVO5VR138hBjVH07DkVqpmpz0-V7wh3FMTEjh7ey-tYaWWITKR37SJUvYxKSaEAB/exec"; // ← MESMO /exec do index.html
      const sess = JSON.parse(localStorage.getItem("session") || "null");
      if (!sess || !sess.token) {
        localStorage.removeItem("session");
        location.replace("index.html");
        return;
      }
      try {
        const res = await fetch(API_BASE + "?path=whoami", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ token: sess.token }),
          cache: "no-store"
        }).then(r => r.json());
        if (!res || !res.session || !res.session.token) {
          localStorage.removeItem("session");
          location.replace("index.html");
          return;
        }
      } catch (e) {
        localStorage.removeItem("session");
        location.replace("index.html");
        return;
      }
      document.documentElement.style.visibility = '';
    })();
  </script>
  <!-- ========== /GUARD ========== -->

  <style>
    :root{
      --bg:#0d1117; --panel:#0f172a; --muted:#95a0b4; --text:#e6edf3;
      --primary:#2563eb; --primary-2:#1d4ed8; --border:#1f2a44;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --chip:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif
    }
    header{
      padding:.75rem 1rem;background:#0b0f1a;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:5
    }
    header .title{font-weight:700;letter-spacing:.2px}
    nav a{
      margin-left:16px;color:var(--muted);text-decoration:none;font-weight:600
    }
    nav a:hover,nav a.active{color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h2{margin:10px 0 16px;border-bottom:1px solid var(--border);padding-bottom:8px}
    .card{
      background:var(--panel);border:1px solid var(--border);
      border-radius:12px;padding:14px
    }
    .grid{display:grid;gap:12px}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input,select,textarea{
      width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);
      border-radius:8px;padding:10px 12px;outline:none
    }
    textarea{resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .btn{
      padding:.65rem 1rem;background:var(--primary);border:0;border-radius:10px;
      color:#fff;font-weight:700;cursor:pointer
    }
    .btn:hover{background:var(--primary-2)}
    .btn-ghost{background:#111827;border:1px solid var(--border);color:#e6edf3}
    .btn-danger{background:var(--danger)}
    .muted{color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:.6rem .75rem;border-bottom:1px solid var(--border);text-align:left}
    .table th{background:#111827}
    .items-head{display:grid;grid-template-columns:200px 140px 120px 110px;gap:10px;padding:8px 0;color:var(--muted);font-size:12px}
    .item-row{display:grid;grid-template-columns:200px 140px 120px 110px;gap:10px;align-items:center;margin:8px 0}
    .chip{background:var(--chip);padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .right{display:flex;justify-content:flex-end}
    .hidden{display:none}
    /* loading bar */
    .loading-bar{height:3px;background:linear-gradient(90deg,var(--primary),#60a5fa);width:0%;transition:width .25s ease;border-radius:999px}
    .mb8{margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <div class="title">🚚 Romaneio</div>
    <nav>
      <a href="#" id="mEnviar" class="active" onclick="showTab('enviar')">Enviar Romaneio</a>
      <a href="#" id="mClientes" onclick="showTab('clientes')">Clientes</a>
      <a href="#" id="mRoms" onclick="showTab('roms')">Romaneios</a>
      <a href="#" id="mFin" onclick="showTab('fin')">Financeiro</a>
      <a href="#" onclick="logout()">Sair</a>
    </nav>
  </header>

  <div class="wrap">
    <!-- barra de carregamento fina -->
    <div id="topLoading" class="loading-bar mb8"></div>

    <!-- ========= ENVIAR ========= -->
    <section id="tab-enviar" class="card">
      <h2>Enviar Romaneio</h2>

      <div class="grid g-3">
        <div>
          <label>ROM</label>
          <input id="rom_rom" placeholder="Ex.: 21" type="number">
        </div>
        <div>
          <label>Data</label>
          <input id="rom_data" type="date">
        </div>
        <div>
          <label>Observações</label>
          <textarea id="rom_obs" rows="1" placeholder="Ex.: Agendar com o cliente"></textarea>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:14px">
        <div class="card" style="padding:12px">
          <div class="row" style="justify-content:space-between">
            <div class="chip">Cliente</div>
            <button class="btn-ghost" onclick="preencherPeloTelefone('cli')">Preencha pelo telefone</button>
          </div>
          <div class="grid g-3" style="margin-top:10px">
            <div>
              <label>Telefone</label>
              <input id="cli_tel" placeholder="(DDD) 90000-0000" inputmode="numeric">
            </div>
            <div>
              <label>Nome</label>
              <input id="cli_nome" placeholder="Nome do cliente">
            </div>
            <div>
              <label>Cidade/UF</label>
              <input id="cli_loc" placeholder="Fortaleza-CE">
            </div>
          </div>
        </div>

        <div class="card" style="padding:12px">
          <div class="row" style="justify-content:space-between">
            <div class="chip">Fornecedor</div>
            <div class="muted">Opcional</div>
          </div>
          <div class="grid g-3" style="margin-top:10px">
            <div>
              <label>Telefone</label>
              <input id="for_tel" placeholder="(DDD) 90000-0000" inputmode="numeric">
            </div>
            <div>
              <label>Nome</label>
              <input id="for_nome" placeholder="Nome do fornecedor">
            </div>
            <div>
              <label>Cidade/UF</label>
              <input id="for_loc" placeholder="Cidade-UF">
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="row" style="justify-content:space-between">
          <div class="chip">Itens</div>
          <button class="btn-ghost" onclick="addItemRow()">+ Item</button>
        </div>

        <div class="items-head" style="margin-top:8px">
          <div>Tipo</div><div>Tamanho</div><div>Qtd</div><div>Ação</div>
        </div>
        <div id="itemsBody"></div>

        <div class="right" style="margin-top:6px">
          <div class="chip">Total: <b id="rom_total" style="margin-left:6px;color:#fff">0</b></div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="chip">Fotos</div>
        <div class="row" style="margin-top:8px;align-items:flex-start;gap:12px">
          <input id="rom_fotos" type="file" accept="image/*" multiple capture="environment">
          <div class="muted">Você pode escolher várias e remover antes de enviar.</div>
        </div>
      </div>

      <div class="right" style="margin-top:16px;gap:10px">
        <button class="btn" onclick="enviarRomaneio()">Enviar Romaneio</button>
      </div>

      <div id="rom_result" class="muted" style="margin-top:10px"></div>
    </section>

    <!-- ========= CLIENTES (placeholder para futuro) ========= -->
    <section id="tab-clientes" class="card hidden">
      <h2>Clientes</h2>
      <div class="muted">Em breve…</div>
    </section>

    <!-- ========= ROMANEIOS (placeholder) ========= -->
    <section id="tab-roms" class="card hidden">
      <h2>Romaneios</h2>
      <div class="muted">Em breve…</div>
    </section>

    <!-- ========= FINANCEIRO (placeholder) ========= -->
    <section id="tab-fin" class="card hidden">
      <h2>Financeiro</h2>
      <div class="muted">Em breve…</div>
    </section>
  </div>

  <script>
    // ========= CONFIG =========
    const API_BASE = "https://script.google.com/macros/s/AKfycbwJwVO5VR138hBjVH07DkVqpmpz0-V7wh3FMTEjh7ey-tYaWWITKR37SJUvYxKSaEAB/exec"; // MESMO /exec do index.html
    const $ = sel => document.querySelector(sel);

    function showTab(id){
      document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $('#tab-'+id).classList.remove('hidden');
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      (id==='enviar') && $('#mEnviar').classList.add('active');
      (id==='clientes') && $('#mClientes').classList.add('active');
      (id==='roms') && $('#mRoms').classList.add('active');
      (id==='fin') && $('#mFin').classList.add('active');
    }
    function logout(){
      localStorage.removeItem("session");
      location.replace("index.html");
    }
    function sess(){ try { return JSON.parse(localStorage.getItem("session"))||null; } catch(_) { return null; } }

    // ========= UI helpers =========
    const topBar = $('#topLoading');
    function startLoading(){ topBar.style.width='0%'; setTimeout(()=> topBar.style.width='60%', 0); }
    function endLoading(){ topBar.style.width='100%'; setTimeout(()=> topBar.style.width='0%', 300); }

    // ========= API helper =========
    async function api(path, body = {}){
      const s = sess();
      const res = await fetch(API_BASE + "?path=" + encodeURIComponent(path), {
        method: "POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify({...body, token: s?.token}),
        cache: "no-store"
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (data && data.error === "unauth") {
        localStorage.removeItem("session");
        location.replace("index.html");
        return Promise.reject(new Error("Sessão expirada"));
      }
      return data;
    }

    // ========= Itens =========
    function addItemRow(){
      const wrap = document.createElement('div');
      wrap.className = 'item-row';
      wrap.innerHTML = `
        <select class="tipo">
          <option value="caixa">Caixa</option>
          <option value="saco">Saco</option>
        </select>
        <select class="tam">
          <option value="p">P</option>
          <option value="m">M</option>
          <option value="g">G</option>
        </select>
        <input class="qtd" type="number" min="0" value="1">
        <button class="btn-ghost" onclick="this.closest('.item-row').remove(); calcTotal()">Remover</button>
      `;
      $('#itemsBody').appendChild(wrap);
      calcTotal();
    }
    function calcTotal(){
      let tot = 0;
      document.querySelectorAll('.item-row .qtd').forEach(i => tot += Number(i.value||0));
      $('#rom_total').textContent = tot;
    }
    document.addEventListener('input', (e)=>{
      if (e.target.classList.contains('qtd')) calcTotal();
    });

    // Preencher pelo telefone (apenas mascara/extra; o cadastro real é no backend)
    function preencherPeloTelefone(prefix){
      const tel = $('#'+prefix+'_tel').value.trim();
      if (!tel) return;
      if (!$('#'+prefix+'_nome').value) $('#'+prefix+'_nome').value = 'Contato ' + tel.slice(-4);
    }

    // Converter arquivos para base64 (fotos)
    function filesToBase64(input){
      const files = Array.from((input.files||[]));
      return Promise.all(files.map(f => new Promise(res => {
        const r = new FileReader();
        r.onload = () => res({ name:f.name, data:r.result });
        r.readAsDataURL(f);
      })));
    }

    // Enviar romaneio
    async function enviarRomaneio(){
      try{
        startLoading();
        const itens = Array.from(document.querySelectorAll('#itemsBody .item-row')).map(row => ({
          tipo: row.querySelector('.tipo').value,
          tamanho: row.querySelector('.tam').value,
          qtd: Number(row.querySelector('.qtd').value||0)
        })).filter(i => i.qtd > 0);

        const fotos = await filesToBase64($('#rom_fotos'));

        const body = {
          rom: $('#rom_rom').value,
          data: $('#rom_data').value,
          obs:  $('#rom_obs').value,
          cliente:     { tel: $('#cli_tel').value, nome: $('#cli_nome').value, local: $('#cli_loc').value },
          fornecedor:  { tel: $('#for_tel').value, nome: $('#for_nome').value, local: $('#for_loc').value },
          itens, fotos
        };

        $('#rom_result').textContent = 'Enviando…';
        const r = await api('/rom/create', body);
        if (r.error) throw new Error(r.error);

        $('#rom_result').innerHTML = `
          <div class="chip" style="color:#fff;background:#06210f;border-color:#0e4429">Romaneio criado!</div>
          <div style="margin-top:6px">Código: <b>${r.cod}</b></div>
          <div style="margin-top:6px"><a href="${r.pdfUrl}" target="_blank">Abrir PDF</a></div>
          <div style="margin-top:6px"><a href="${r.whatsappUrl}" target="_blank">Enviar no WhatsApp</a></div>
        `;
      } catch(err){
        $('#rom_result').innerHTML = `<span style="color:#ffb4b4">Erro: ${err.message}</span>`;
      } finally {
        endLoading();
      }
    }

    // estado inicial
    document.addEventListener('DOMContentLoaded', ()=>{
      showTab('enviar');
      addItemRow();
      const today = new Date().toISOString().slice(0,10);
      $('#rom_data').value = today;
    });
  </script>
</body>
</html>
