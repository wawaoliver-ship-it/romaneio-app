<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Romaneio ‚Ä¢ Painel</title>
<style>
  :root{
    --bg:#0f172a;--surface:#0b1220;--ink:#e5e7eb;--muted:#94a3b8;
    --brand:#2563eb;--danger:#ef4444;--ok:#16a34a;border:1px solid #1f2937
  }
  [data-theme="light"]{
    --bg:#f8fafc;--surface:#ffffff;--ink:#0f172a;--muted:#475569;
    --brand:#1d4ed8;--danger:#b91c1c;--ok:#15803d
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:500 15px/1.45 system-ui,Segoe UI,Arial}
  header{position:sticky;top:0;z-index:10;background:var(--surface);border-bottom:1px solid #1f2937}
  .bar{max-width:1100px;margin:auto;display:flex;align-items:center;gap:8px;padding:12px 14px}
  .brand{font-weight:800;font-size:18px;margin-right:auto}
  .btn{height:36px;display:inline-grid;place-items:center;padding:0 12px;border-radius:9px;border:1px solid #1f2937;background:transparent;color:var(--ink);cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  main{max-width:1100px;margin:14px auto;padding:0 14px}
  .card{background:var(--surface);border:1px solid #1f2937;border-radius:14px;padding:16px;margin-bottom:16px}
  h2{margin:0 0 12px}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:transparent;color:var(--ink);outline:none}
  .grid{display:grid;gap:12px}
  @media(min-width:820px){.grid.cols-3{grid-template-columns:1fr 1fr 1fr}}
  .row{display:flex;gap:8px;align-items:center}
  .item-row{display:grid;grid-template-columns:1fr 1fr 90px 90px;gap:8px;align-items:center;margin-bottom:8px}
  .thumbs{display:flex;gap:10px;flex-wrap:wrap}
  .thumb{width:74px;height:74px;border-radius:10px;border:1px solid #1f2937;background:#0a1020 center/cover no-repeat;position:relative}
  .thumb button{position:absolute;top:2px;right:2px;border:0;background:rgba(0,0,0,.45);color:#fff;border-radius:6px;cursor:pointer}
  .muted{color:var(--muted)}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #1f2937}
  .ok{color:#22c55e}
  .error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#fecaca;padding:8px 10px;border-radius:10px;display:none;margin-top:10px}
  dialog{border:0;border-radius:14px;max-width:420px}
  dialog .rec{padding:16px}
  .rec h3{margin:0 0 10px}
  .rec pre{background:#0b1020;color:#e5e7eb;padding:10px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">üöö Romaneio <span id="who" class="muted"></span></div>
    <button class="btn" id="navRom">Enviar Romaneio</button>
    <button class="btn" id="navUsers">Usu√°rios</button>
    <button class="btn" id="theme">üåô/‚òÄÔ∏è</button>
    <button class="btn danger" id="logout">Sair</button>
  </div>
</header>

<main>

  <!-- ROM -->
  <section id="secRom" class="card">
    <h2>Enviar Romaneio</h2>

    <div class="grid cols-3">
      <div>
        <label>ROM</label>
        <input id="rom" placeholder="Ex.: 21">
      </div>
      <div>
        <label>Data</label>
        <input id="data" type="date">
      </div>
      <div>
        <label>Observa√ß√µes</label>
        <input id="obs" placeholder="Ex.: Doca 3, at√© 16h">
      </div>
    </div>

    <h3>Cliente</h3>
    <div class="grid cols-3">
      <div><label>Telefone</label><input id="cli_tel" placeholder="85999999999"></div>
      <div><label>Nome</label><input id="cli_nome" placeholder="Nome do cliente"></div>
      <div><label>Cidade/UF</label><input id="cli_loc" placeholder="Fortaleza/CE"></div>
    </div>

    <h3>Fornecedor <span class="muted">(opcional, mas obrigat√≥rio no envio)</span></h3>
    <div class="grid cols-3">
      <div><label>Telefone</label><input id="for_tel" placeholder="85999999999"></div>
      <div><label>Nome</label><input id="for_nome" placeholder="Nome do fornecedor"></div>
      <div><label>Cidade/UF</label><input id="for_loc" placeholder="Maracana√∫/CE"></div>
    </div>

    <h3 class="row">Itens <span class="pill">Total: <span id="tot">0</span></span></h3>
    <div id="itens"></div>
    <button class="btn" id="addItem">+ Item</button>

    <h3>Fotos</h3>
    <input type="file" id="files" accept="image/*" multiple>
    <div class="row" style="margin:8px 0">
      <button class="btn" id="addMore">+ Adicionar fotos</button>
      <button class="btn" id="clearPhotos">Limpar fotos</button>
      <span class="muted" id="countPhotos"></span>
    </div>
    <div class="thumbs" id="thumbs"></div>

    <div class="row" style="justify-content:flex-start;margin-top:14px">
      <button class="btn primary" id="send">Enviar</button>
      <button class="btn" id="clearAll">Limpar</button>
    </div>

    <div class="error" id="errRom"></div>

    <div class="card" style="margin-top:12px">
      <strong>Diagn√≥stico r√°pido</strong>
      <div class="muted">Mostra o que o servidor recebeu em /echo.</div>
      <pre id="echoBox" class="muted" style="white-space:pre-wrap"></pre>
      <button class="btn" id="btnEcho">Testar conex√£o</button>
    </div>
  </section>

  <!-- USU√ÅRIOS (somente placeholder) -->
  <section id="secUsers" class="card" style="display:none">
    <h2>Usu√°rios</h2>
    <div class="muted">Listagem/edi√ß√£o dependem de endpoints /users (n√£o implementados neste backend).</div>
  </section>
</main>

<!-- POPUP do recibo com o c√≥digo -->
<dialog id="pop">
  <div class="rec">
    <h3>Romaneio enviado ‚úÖ</h3>
    <div id="recBody" class="muted"></div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <a id="recPdf" class="btn" target="_blank">Abrir PDF</a>
      <a id="recWa" class="btn" target="_blank">WhatsApp</a>
      <button class="btn primary" onclick="document.getElementById('pop').close()">OK</button>
    </div>
  </div>
</dialog>

<script>
/** sess√£o + API */
const API_BASE = localStorage.getItem("rom_api") || "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgNJA1vrNW6E5KMUUpA_eDS1PyLc1ymDTn6TV-NoUUuKqrUhXYySJ-uk9wpWxlPFUEo5JZwfyyEEoeqZetFzVzlnPMvajAz_4AMr6DxnWXS0NwHJeYL9kqXBQLiYX-4Ew8kc4sRjF7kzl3OfVVey1bKUUpHGBpg1oTQWk5ULOh_wth0fq_ljZYJl_clpNupHt8FpBBYkPAt64XWqO_Qcu9GZcdfNpWeSI4r8IyI2Yh8DvYGNVhYK9fYhUMlMRkeFSqmJGB65C0oDdAD2bT5fGAkDr4jAA&lib=MgCquoYzRceSzn8l97_yAGg5THVlN2byw";
const TOKEN    = localStorage.getItem("rom_token") || "";
const USER     = JSON.parse(localStorage.getItem("rom_user")||"{}");

if(!API_BASE || !TOKEN){ location.href = "index.html?v="+Date.now(); }

document.getElementById('who').textContent = USER?.usuario ? ("("+USER.usuario+")") : "";

/** tema */
(function(){
  const k="rom_theme";
  const set=(t)=>document.documentElement.setAttribute("data-theme",t);
  set(localStorage.getItem(k)||"dark");
  document.getElementById("theme").onclick=()=>{
    const cur = (document.documentElement.getAttribute("data-theme")==="light")?"dark":"light";
    localStorage.setItem(k,cur); set(cur);
  }
})();

/** navega√ß√£o */
const secRom  = document.getElementById('secRom');
const secUser = document.getElementById('secUsers');
document.getElementById('navRom').onclick = ()=>{secRom.style.display='block';secUser.style.display='none';}
document.getElementById('navUsers').onclick=()=>{secRom.style.display='none';secUser.style.display='block';}

/** api helper */
async function api(path, data={}){
  const r = await fetch(API_BASE+"?path="+encodeURIComponent(path),{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({...data, token:TOKEN})
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

/** campos base */
const $ = (id)=>document.getElementById(id);
$('data').valueAsDate = new Date();
function err(t){ const e=$('errRom'); if(t){e.style.display='block';e.textContent=t}else e.style.display='none'; }

/** itens */
const itensEl = $('itens');
let itens = [];
function renderItens(){
  itensEl.innerHTML = "";
  itens.forEach((it, idx)=>{
    const row = document.createElement('div'); row.className='item-row';
    const s1 = document.createElement('select'); s1.innerHTML='<option>Caixa</option><option>Saco</option>';
    s1.value = it.tipo;
    s1.onchange = ()=> {itens[idx].tipo = s1.value;};
    const s2 = document.createElement('select'); s2.innerHTML='<option>P</option><option>M</option><option>G</option>';
    s2.value = it.tamanho;
    s2.onchange= ()=> {itens[idx].tamanho = s2.value;};
    const q  = document.createElement('input'); q.type='number'; q.min='1'; q.value=it.qtd;
    q.oninput = ()=> {itens[idx].qtd = Number(q.value||0); updateTotal();};
    const rm = document.createElement('button'); rm.className='btn danger'; rm.textContent='Remover';
    rm.onclick = ()=>{ itens.splice(idx,1); renderItens(); updateTotal(); };
    row.append(s1,s2,q,rm);
    itensEl.append(row);
  });
  updateTotal();
}
function addItem(){ itens.push({tipo:'Caixa', tamanho:'P', qtd:1}); renderItens(); }
function updateTotal(){
  const t = itens.reduce((s,i)=> s + Number(i.qtd||0), 0);
  $('tot').textContent = String(t);
}
$('addItem').onclick = addItem;
addItem();

/** fotos (pr√©-visualiza√ß√£o e base64) */
let fotos = []; // {dataUrl}
function syncThumbs(){
  $('countPhotos').textContent = fotos.length? `${fotos.length} foto(s)` : '';
  const box = $('thumbs'); box.innerHTML='';
  fotos.forEach((f,idx)=>{
    const d=document.createElement('div'); d.className='thumb'; d.style.backgroundImage=`url(${f.dataUrl})`;
    const b=document.createElement('button'); b.textContent='x'; b.onclick=()=>{fotos.splice(idx,1);syncThumbs();};
    d.append(b); box.append(d);
  });
}
$('files').onchange = async (e)=>{
  const files = Array.from(e.target.files||[]);
  for(const file of files){
    const dataUrl = await fileToDataUrl(file);
    fotos.push({dataUrl});
  }
  syncThumbs();
  e.target.value = "";
};
$('addMore').onclick = ()=> $('files').click();
$('clearPhotos').onclick = ()=> {fotos=[]; syncThumbs();};
function fileToDataUrl(f){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
}

/** limpar tudo */
$('clearAll').onclick=()=>{
  ['rom','obs','cli_tel','cli_nome','cli_loc','for_tel','for_nome','for_loc'].forEach(id=>$(id).value='');
  $('data').valueAsDate=new Date();
  itens=[]; addItem();
  fotos=[]; syncThumbs();
  err('');
};

/** enviar */
$('send').onclick = async ()=>{
  err('');
  try{
    const payload = {
      rom: $('rom').value.trim(),
      data: $('data').value,
      obs:  $('obs').value.trim(),
      cliente:{ tel:$('cli_tel').value.trim(), nome:$('cli_nome').value.trim(), local:$('cli_loc').value.trim() },
      fornecedor:{ tel:$('for_tel').value.trim(), nome:$('for_nome').value.trim(), local:$('for_loc').value.trim() },
      itens: itens.map(i=>({tipo:i.tipo.toLowerCase(), tamanho:i.tamanho.toLowerCase(), qtd:Number(i.qtd||0)})),
      fotos: fotos.map(f=>({data:f.dataUrl}))
    };

    // diagn√≥stico: ecoa o que estamos mandando
    const echo = await api("/echo", payload);
    $('echoBox').textContent = JSON.stringify(echo, null, 2);

    // envio real
    const j = await api("/rom/create", payload);
    if(j.error){ err(j.error); return; }

    // popup recibo
    $('recBody').innerHTML =
      `<div><b>C√≥digo:</b> <span class="pill">${j.cod}</span></div>
       <div class="muted">Anote o c√≥digo nas caixas.</div>`;
    $('recPdf').href = j.pdfUrl;
    $('recWa').href  = j.whatsappUrl;
    document.getElementById('pop').showModal();

    // limpar ap√≥s sucesso
    $('clearAll').click();
  }catch(e){
    err("Erro: "+e.message);
  }
};

/** teste ping/echo */
$('btnEcho').onclick = async ()=>{
  $('echoBox').textContent = '';
  try{
    const j = await api("/ping",{});
    $('echoBox').textContent = JSON.stringify(j,null,2);
  }catch(e){
    $('echoBox').textContent = "Erro: "+e.message;
  }
};

/** logout */
$('logout').onclick = ()=>{
  localStorage.removeItem("rom_api");
  localStorage.removeItem("rom_token");
  localStorage.removeItem("rom_user");
  location.href = "index.html?v="+Date.now();
};
</script>
</body>
</html>
