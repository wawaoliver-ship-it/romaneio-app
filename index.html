<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio ‚Ä¢ Login</title>
  <meta name="theme-color" content="#0d1117" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0d1117; --panel:#0f172a; --muted:#95a0b4; --text:#e6edf3;
      --primary:#2563eb; --primary-2:#1d4ed8; --border:#1f2a44;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      display:flex;align-items:center;justify-content:center;
      padding:16px
    }
    .card{
      width:100%;max-width:420px;background:#0b0f1a;border:1px solid var(--border);
      border-radius:14px;padding:20px 18px 16px
    }
    h1{margin:0 0 14px;font-size:20px}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input{
      width:100%;padding:12px;background:#0b1220;border:1px solid var(--border);
      border-radius:10px;color:var(--text);outline:none
    }
    .btn{
      width:100%;margin-top:14px;padding:12px;background:var(--primary);
      border:0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer
    }
    .btn[disabled]{opacity:.7;cursor:not-allowed}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.4}
    .status{margin-top:10px;font-size:13px}
    .status.ok{color:#86efac}
    .status.err{color:#fecaca}
    .topbar{position:fixed;top:0;left:0;height:3px;width:0%;
      background:linear-gradient(90deg,var(--primary),#60a5fa);
      transition:width .25s ease;z-index:5}
    .small{margin-top:16px;text-align:center;color:#677189;font-size:12px}
  </style>
</head>
<body>
  <div id="topbar" class="topbar"></div>

  <main class="card">
    <h1>üîê Acesso</h1>

    <label for="user">Usu√°rio</label>
    <input id="user" autocomplete="username" placeholder="admin" />

    <label for="pass">Senha</label>
    <input id="pass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

    <button id="btn" class="btn">Entrar</button>

    <div id="status" class="status"></div>

    <div class="hint">
      Admin cria/gerencia usu√°rios via planilha. Precisa de acesso? Fale com o respons√°vel.
    </div>

    <div class="small">v1 ‚Ä¢ PWA (instal√°vel)</div>
  </main>

  <script>
    // ======== CONFIG ========
    const API_BASE = "https://script.google.com/macros/s/AKfycbwJwVO5VR138hBjVH07DkVqpmpz0-V7wh3FMTEjh7ey-tYaWWITKR37SJUvYxKSaEAB/exec";
    const $ = (s)=>document.querySelector(s);
    const top = $('#topbar'), btn = $('#btn'), st = $('#status');

    function barStart(){ top.style.width='0%'; setTimeout(()=> top.style.width='65%', 0); }
    function barEnd(){ top.style.width='100%'; setTimeout(()=> top.style.width='0%', 300); }
    function setStatus(msg, type=''){ st.className='status '+(type||''); st.textContent=msg||''; }
    function saveSession(sess){ localStorage.setItem('session', JSON.stringify(sess)); }
    function disableForm(dis){ btn.disabled=dis; btn.textContent = dis ? 'Carregando‚Ä¶' : 'Entrar'; }
    function timeout(ms){ return new Promise((_,rej)=> setTimeout(()=> rej(new Error('Tempo esgotado')), ms)); }

    async function login(){
      const usuario = $('#user').value.trim();
      const senha   = $('#pass').value.trim();
      if(!usuario || !senha){ setStatus('Informe usu√°rio e senha.', 'err'); return; }

      setStatus(''); disableForm(true); barStart();
      try{
        const res = await Promise.race([
          fetch(API_BASE + "?path=login", {
            method:"POST",
            headers:{"Content-Type":"text/plain;charset=utf-8"},
            body: JSON.stringify({ usuario, senha }),
            cache:"no-store"
          }),
          timeout(15000)
        ]);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        if(data.error){
          if (data.error.includes('inativo')) throw new Error('Usu√°rio inativo. Fale com o respons√°vel.');
          if (data.error.includes('Usu√°rio/senha')) throw new Error('Preencha usu√°rio e senha.');
          if (data.error.includes('Credenciais')) throw new Error('Credenciais inv√°lidas. Verifique usu√°rio/senha.');
          throw new Error(data.error);
        }
        if(!data.session?.token) throw new Error('Resposta inv√°lida da API.');

        saveSession(data.session);
        setStatus('Login conclu√≠do! Redirecionando‚Ä¶', 'ok');
        location.replace('app.html');
      }catch(err){
        if(!navigator.onLine) setStatus('Sem conex√£o com a internet.', 'err');
        else setStatus(err.message || 'Falha ao entrar.', 'err');
      }finally{
        disableForm(false); barEnd();
      }
    }

    btn.addEventListener('click', login);
    document.addEventListener('keydown', e=>{ if(e.key==='Enter') login(); });
    $('#user').focus();

    // J√° logado? tenta whoami e pula pro app
    (async ()=>{
      const sess = JSON.parse(localStorage.getItem('session')||'null');
      if(!sess?.token) return;
      try{
        const r = await fetch(API_BASE+"?path=whoami", {
          method:"POST", headers:{"Content-Type":"text/plain;charset=utf-8"},
          body: JSON.stringify({ token: sess.token }), cache:"no-store"
        }).then(x=>x.json());
        if(r?.session?.token) location.replace('app.html');
      }catch(_){}
    })();
  </script>
</body>
</html>
