<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio ‚Ä¢ Login</title>
  <meta name="theme-color" content="#0d1117" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#98a2b3; --text:#e6edf3;
      --primary:#2563eb; --primary-2:#1d4ed8; --border:#1f2a44;
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100dvh;background:radial-gradient(1200px 600px at 20% -10%,rgba(37,99,235,.18),transparent 60%),var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;display:grid;place-items:center}
    .card{width:min(560px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:22px 22px 18px}
    h1{margin:.3rem 0 1rem;font-size:20px}
    label{font-size:12px;color:var(--muted);display:block;margin:.25rem 0 .4rem}
    input{width:100%;background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:12px 12px}
    .row{margin:.65rem 0}
    .btn{width:100%;padding:.75rem 1rem;background:var(--primary);border:0;border-radius:10px;color:#fff;font-weight:800;cursor:pointer}
    .btn:hover{background:var(--primary-2)}
    .muted{color:var(--muted);font-size:12px;margin-top:.75rem}
    .brand{display:flex;gap:8px;align-items:center;margin-bottom:.25rem}
    .brand b{font-size:18px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
    .bar{width:200px;height:8px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#2563eb,#60a5fa);animation:load 1.2s infinite}
    @keyframes load{0%{width:0}50%{width:90%}100%{width:0;transform:translateX(100%)}}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0b1220;border:1px solid var(--border);padding:10px 14px;border-radius:10px;display:none;z-index:60}
    .toast.ok{border-color:rgba(22,163,74,.5)}
    .toast.err{border-color:rgba(220,38,38,.5)}
    .ver{margin-top:22px;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <div class="brand">üöö <b>Romaneio</b></div>
    <h1>Acesso</h1>

    <div class="row">
      <label>Usu√°rio</label>
      <input id="user" placeholder="admin" autocomplete="username"/>
    </div>
    <div class="row">
      <label>Senha</label>
      <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    </div>
    <div class="row">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>

    <div class="muted">
      Admin cria/gerencia usu√°rios via planilha. Precisa de acesso? Fale com o respons√°vel.
    </div>
    <div class="ver">v1 ‚Ä¢ PWA (instal√°vel)</div>
  </div>

  <div id="overlay" class="overlay"><div class="bar"><span></span></div></div>
  <div id="toast" class="toast"></div>

<script>
/* ====== CONFIG ====== */
const API_BASE = "https://script.google.com/macros/s/AKfycbwJwVO5VR138hBjVH07DkVqpmpz0-V7wh3FMTEjh7ey-tYaWWITKR37SJUvYxKSaEAB/exec";

/* ====== UI helpers ====== */
const $ = (s)=>document.querySelector(s);
function setLoading(v){ $("#overlay").style.display = v ? "flex" : "none"; }
function toast(msg, kind="ok"){ const t=$("#toast"); t.textContent=msg; t.className="toast "+kind; t.style.display="block"; setTimeout(()=>t.style.display="none", 3200); }

/* ====== j√° tem sess√£o? valida e redireciona ====== */
(async function autoRedirectIfSession(){
  try{
    const s = JSON.parse(localStorage.getItem("session")||"null");
    if (!s?.token) return; // nada a fazer
    setLoading(true);
    const r = await fetch(API_BASE+"?path=whoami", {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ token: s.token }),
      cache: "no-store"
    }).then(x=>x.json()).catch(()=>null);
    setLoading(false);
    if (r?.session?.token) {
      location.replace("app.html");
    } else {
      localStorage.removeItem("session");
    }
  } catch(_){ setLoading(false); }
})();

/* ====== login ====== */
async function doLogin(){
  const usuario = $("#user").value.trim();
  const senha   = $("#pass").value.trim();
  if(!usuario || !senha){ toast("Preencha usu√°rio e senha.", "err"); return; }

  setLoading(true);
  let res;
  try{
    res = await fetch(API_BASE+"?path=login", {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ usuario, senha }),
      cache:"no-store"
    });
  }catch(err){
    setLoading(false);
    toast("Sem conex√£o com a API. Verifique sua internet.", "err");
    return;
  }
  setLoading(false);

  if (!res.ok){ toast("Falha (HTTP "+res.status+").", "err"); return; }

  let json = {};
  try{ json = await res.json(); }catch(_){}
  if (json.error){
    if (/inativo/i.test(json.error)) toast("Usu√°rio inativo.", "err");
    else if (/credenciais/i.test(json.error)) toast("Credenciais inv√°lidas.", "err");
    else toast(json.error, "err");
    return;
  }
  if (!json.session?.token){ toast("Resposta inesperada da API.", "err"); return; }

  localStorage.setItem("session", JSON.stringify(json.session));
  toast("Login conclu√≠do. Redirecionando‚Ä¶", "ok");
  setTimeout(()=> location.replace("app.html"), 600);
}

$("#btnLogin").addEventListener("click", doLogin);
document.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
</script>
</body>
</html>
