<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Romaneio ‚Ä¢ Login</title>
  <!-- anti-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#0f172a; --card:#0b1222; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#3b82f6; --primary-2:#1d4ed8; --border:#1f2a44; --chip:#111a31;
      --ok:#22c55e; --err:#ef4444;
    }
    .light{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#2563eb; --primary-2:#1e40af; --border:#e5e7eb; --chip:#edf2ff;
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:0 0 8px}
    .muted{color:var(--muted)}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
    input{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0b1222;color:var(--text)
    }
    .light input{background:#fff}
    .row{display:flex;gap:10px;align-items:center}
    .between{display:flex;justify-content:space-between;align-items:center}
    .btn{
      width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);
      background:var(--primary);color:#fff;cursor:pointer;font-weight:600
    }
    .ghost{background:transparent;color:var(--text)}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--chip);cursor:pointer}
    .status{margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
    .ok{background:var(--ok);color:#fff;border-color:transparent}
    .err{background:var(--err);color:#fff;border-color:transparent}
    .eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;opacity:.7}
    .relative{position:relative}
    .footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center}
    a{color:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="between">
        <h1>üöö Romaneio</h1>
        <button id="themeBtn" class="chip">üåô/‚òÄÔ∏è</button>
      </div>
      <div class="muted">Acesse com seu usu√°rio e senha.</div>

      <label>Usu√°rio</label>
      <input id="usuario" placeholder="ex.: admin" autocomplete="username" />

      <label>Senha</label>
      <div class="relative">
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        <span id="toggleEye" class="eye">üëÅÔ∏è</span>
      </div>

      <div style="height:10px"></div>
      <button id="btnLogin" class="btn">Entrar</button>

      <div id="msg" class="status" style="display:none"></div>

      <div class="footer">
        <small class="muted">Precisa de ajuda? Fale com o suporte.</small>
        <a id="testPing" class="chip ghost" href="#">Testar conex√£o</a>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG: USE O MESMO /exec DO APP ======
    const API_BASE = "https://script.google.com/macros/s/AKfycbzahPVwksRN4y6WnYZ6sXfCWftB_YDiL2nfyTw0QPMelz_A_3GKmrtMV-4QysIhTu8R/exec";

    // ====== TEMA ======
    const root = document.documentElement;
    function applyTheme(){
      const t = localStorage.getItem("theme") || "dark";
      if(t==="light") root.classList.add("light"); else root.classList.remove("light");
    }
    applyTheme();
    document.getElementById("themeBtn").onclick = ()=>{
      const cur = localStorage.getItem("theme")||"dark";
      localStorage.setItem("theme", cur==="dark"?"light":"dark");
      applyTheme();
    };

    // ====== UI helpers ======
    const $ = (id)=>document.getElementById(id);
    function showMsg(text, kind=""){
      const el = $("msg");
      el.textContent = text;
      el.className = "status " + (kind==="ok"?"ok":kind==="err"?"err":"");
      el.style.display = "block";
    }

    // ====== HTTP ======
    async function post(path, body){
      const r = await fetch(`${API_BASE}?path=${encodeURIComponent(path)}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body||{})
      });
      return await r.json();
    }

    // ====== Guarda: se j√° tem sess√£o v√°lida, vai pro app ======
    (async()=>{
      try{
        const sess = JSON.parse(localStorage.getItem("sess")||"null");
        if(sess && sess.token){
          const w = await post("/whoami",{ token:sess.token });
          if(w && w.session && w.session.usuario){
            location.href = "./app.html";
            return;
          }else{
            localStorage.removeItem("sess");
          }
        }
      }catch(e){/* silencia */}
    })();

    // ====== Login ======
    async function doLogin(){
      const usuario = $("usuario").value.trim();
      const senha   = $("senha").value;
      if(!usuario || !senha){ showMsg("Informe usu√°rio e senha", "err"); return; }
      try{
        showMsg("Conectando‚Ä¶");
        const rsp = await post("/login", { usuario, senha });
        if(rsp && rsp.session && rsp.session.token){
          localStorage.setItem("sess", JSON.stringify(rsp.session));
          showMsg("Login ok. Redirecionando‚Ä¶", "ok");
          setTimeout(()=>location.href="./app.html", 400);
        }else{
          showMsg(rsp?.error || "Falha no login", "err");
        }
      }catch(err){
        showMsg("Erro de rede: " + (err?.message||err), "err");
      }
    }
    $("btnLogin").onclick = doLogin;
    $("senha").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    // mostrar/ocultar senha
    $("toggleEye").onclick = ()=>{
      const i = $("senha");
      i.type = i.type === "password" ? "text" : "password";
    };

    // ====== Teste de conex√£o ======
    $("testPing").onclick = async (e)=>{
      e.preventDefault();
      try{
        const pong = await post("/ping",{});
        if(pong && pong.pong) showMsg("Conex√£o ok ("+pong.at+")", "ok");
        else showMsg("Ping sem sucesso", "err");
      }catch(err){
        showMsg("Ping falhou: " + (err?.message||err), "err");
      }
    };
  </script>
</body>
</html>
