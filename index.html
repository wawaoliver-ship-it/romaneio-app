<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0d1117" />
<title>Romaneio ‚Ä¢ Login</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{
  --bg:#0b0f19;--panel:#0f172a;--muted:#8a94a6;--text:#e6edf3;
  --primary:#2563eb;--primary-hover:#1d4ed8;--border:#1f2a44;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
header{position:sticky;top:0;background:#0d1117;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;align-items:center}
.brand{font-weight:700;letter-spacing:.3px;color:#9abaff}
.card{max-width:420px;margin:48px auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px}
h1{margin:6px 0 18px 0;font-size:20px;color:#c7d2fe}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
input{background:#0b0f19;border:1px solid #243146;color:var(--text);border-radius:10px;padding:12px}
button{border:1px solid #334155;background:#0b0f19;color:var(--text);padding:12px;border-radius:10px;cursor:pointer}
button.primary{background:var(--primary);border-color:var(--primary)}
button:hover{opacity:.95}
pre{background:#0b1020;border:1px solid var(--border);padding:10px;border-radius:12px;overflow:auto;color:#9aa4b2}
.note{color:#9aa4b2;font-size:.92rem}
footer{padding:18px;color:#9aa4b2;text-align:center}
</style>
</head>
<body>
  <header><div class="brand">üöö Romaneio</div></header>
  <main class="card">
    <h1>Acesso</h1>
    <div class="field">
      <label>Usu√°rio</label>
      <input id="usuario" autocomplete="username" placeholder="admin">
    </div>
    <div class="field">
      <label>Senha</label>
      <input id="senha" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="field">
      <button id="btnLogin" class="primary">Entrar</button>
    </div>
    <p class="note">Admin cria/gerencia usu√°rios via planilha. Precisa de acesso? Fale com o respons√°vel.</p>
    <pre id="out" style="display:none"></pre>
  </main>
  <footer>v1 ‚Ä¢ PWA (instal√°vel)</footer>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbyGZu5c4vTiXjQx5Ud45m0Ij3Dotejl_ziYTdFmjtWXU4cPRz1i2qWLPkVF4RzhuIMr/exec";

const $ = sel => document.querySelector(sel);
const out = $("#out");

function logBox(obj, ok=true){
  out.style.display="block";
  out.textContent = (ok?"‚úÖ ":"‚ùå ") + (typeof obj==="string"?obj:JSON.stringify(obj,null,2));
}
function saveSession(s){ localStorage.setItem("rom.session", JSON.stringify(s)); }
function getSession(){ try{return JSON.parse(localStorage.getItem("rom.session")||"null")}catch(_){return null} }

async function api(path, data={}){
  const sess = getSession();
  const url = API_BASE + "?path=" + encodeURIComponent(path) + (sess && sess.token ? "&token="+encodeURIComponent(sess.token) : "");
  const res = await fetch(url, {
    method:"POST",
    mode:"cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(data)
  });
  return await res.json();
}

async function boot(){
  try{
    // se j√° tem sess√£o, valida e vai pro app
    const sess = getSession();
    if (sess && sess.token){
      const r = await api("/whoami", {});
      if (r && r.session && r.session.token===sess.token) {
        location.href = "app.html";
        return;
      } else {
        localStorage.removeItem("rom.session");
      }
    }
    // s√≥ pra feedback: ping
    const ping = await fetch(API_BASE + "?path=/ping").then(r=>r.json()).catch(()=>({error:"ping falhou"}));
    logBox({ ping }, true);
  }catch(err){
    logBox("Erro ao inicializar: "+err, false);
  }
}

$("#btnLogin").addEventListener("click", async ()=>{
  try{
    out.style.display="none";
    const usuario = $("#usuario").value.trim();
    const senha = $("#senha").value;
    if (!usuario || !senha) return logBox("Informe usu√°rio e senha", false);

    logBox("Fazendo login...");
    const r = await api("/login", { usuario, senha });
    if (!r || r.error) return logBox(r?.error || "Falha no login", false);

    saveSession(r.session);
    logBox({ "Login OK": r.session }, true);
    location.href = "app.html";
  }catch(err){
    logBox("Erro: "+err, false);
  }
});

boot();

// PWA
if ("serviceWorker" in navigator) {
  window.addEventListener("load", ()=> navigator.serviceWorker.register("./sw.js").catch(()=>{}));
}
</script>
</body>
</html>
