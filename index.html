<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Romaneio ‚Ä¢ Login</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#0f172a; --card:#0b1222; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#3b82f6; --primary-2:#1d4ed8; --border:#1f2a44; --chip:#111a31;
      --ok:#22c55e; --err:#ef4444;
    }
    .light{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --primary:#2563eb; --primary-2:#1e40af; --border:#e5e7eb; --chip:#edf2ff;
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:0 0 8px}
    .muted{color:var(--muted)}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0b1222;color:var(--text)}
    .light input{background:#fff;color:#0f172a}
    .btn{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--chip);cursor:pointer}
    .status{margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
    .ok{background:var(--ok);color:#fff;border-color:transparent}
    .err{background:var(--err);color:#fff;border-color:transparent}
    .between{display:flex;justify-content:space-between;align-items:center}
    .eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:.7;cursor:pointer}
    .relative{position:relative}
    .footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center}
    a{color:inherit}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="between">
        <h1>üöö Romaneio</h1>
        <button id="themeBtn" class="chip">üåô/‚òÄÔ∏è</button>
      </div>
      <div class="muted">Acesse com seu usu√°rio e senha.</div>

      <label>Usu√°rio</label>
      <input id="usuario" placeholder="ex.: admin" autocomplete="username" />

      <label>Senha</label>
      <div class="relative">
        <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        <span id="toggleEye" class="eye">üëÅÔ∏è</span>
      </div>

      <div style="height:10px"></div>
      <button id="btnLogin" class="btn">Entrar</button>

      <div id="msg" class="status" style="display:none"></div>

      <div class="footer">
        <small class="muted">Problema de conex√£o? Teste abaixo.</small>
        <a id="testPing" class="chip" href="#">Testar</a>
      </div>
    </div>
  </div>

  <script>
    // ========= TROQUE AQUI PELO SEU /exec =========
    const API_BASE = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLj1he6pEbcg2BYwJJotAEvhpzl5YZsnQxW8BfPXrcje0CxInM7VSp-qK7VEdwzDiSSXEIShjP-tonbqbFx7RzgBu_UCmzjeprZ_MYo3xo4efKcUPZdZcyYbYRcrIJGwAgAach_q9_tF5RzbwA3lWkJQXbYsI7V5FbImQHhPd7GVwAKhRPzhs45AfmXK0GuBaNUZrowWYwbVVAwW-XSkqdizQArbCFh-qiW_0qVGzIx4xbDE0iL4NKWi3laib5l7pVqV8OT-wWV9J8EC8tsWvFdgdrGPKg&lib=MgCquoYzRceSzn8l97_yAGg5THVlN2byw";
    // ==============================================

    // tema
    const root = document.documentElement;
    const applyTheme = ()=> (localStorage.getItem("theme")==="light" ? root.classList.add("light") : root.classList.remove("light"));
    applyTheme();
    document.getElementById("themeBtn").onclick = ()=>{
      const cur = localStorage.getItem("theme")||"dark";
      localStorage.setItem("theme", cur==="dark"?"light":"dark");
      applyTheme();
    };

    // helpers
    const $ = (id)=>document.getElementById(id);
    function showMsg(t,k=""){ const el=$("msg"); el.textContent=t; el.className="status "+(k==="ok"?"ok":k==="err"?"err":""); el.style.display="block"; }

    async function post(path, body){
      const r = await fetch(`${API_BASE}?path=${encodeURIComponent(path)}`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body||{})
      });
      return r.json();
    }

    // guarda: j√° logado?
    (async ()=>{
      try{
        const sess = JSON.parse(localStorage.getItem("sess") || localStorage.getItem("session") || "null");
        if(sess && sess.token){
          const w = await post("/whoami",{ token: sess.token });
          if(w && w.session && w.session.usuario){
            location.replace(`./app.html?v=${Date.now()}`);
            return;
          }else{
            localStorage.removeItem("sess");
            localStorage.removeItem("session");
          }
        }
      }catch(_){}
    })();

    async function doLogin(){
      const usuario = $("usuario").value.trim();
      const senha   = $("senha").value;
      if(!usuario || !senha){ showMsg("Informe usu√°rio e senha","err"); return; }
      try{
        showMsg("Conectando‚Ä¶");
        const rsp = await post("/login",{usuario,senha});
        if(rsp && rsp.session && rsp.session.token){
          // grava nas DUAS chaves para compatibilidade
          localStorage.setItem("sess", JSON.stringify(rsp.session));
          localStorage.setItem("session", JSON.stringify(rsp.session));
          showMsg("Login conclu√≠do. Redirecionando‚Ä¶","ok");
          // for√ßa navega√ß√£o sem voltar
          setTimeout(()=>location.replace(`./app.html?v=${Date.now()}`), 250);
        }else{
          showMsg(rsp?.error || "Falha no login","err");
        }
      }catch(e){
        showMsg("Erro de rede: "+(e?.message||e),"err");
      }
    }
    $("btnLogin").onclick = doLogin;
    $("senha").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });
    $("toggleEye").onclick = ()=>{ const i=$("senha"); i.type = i.type==="password"?"text":"password"; };

    // teste de ping
    $("testPing").onclick = async (ev)=>{
      ev.preventDefault();
      try{
        const pong = await post("/ping",{});
        if(pong && pong.pong) showMsg("Conex√£o OK ("+pong.at+")","ok");
        else showMsg("Ping sem sucesso","err");
      }catch(e){ showMsg("Ping falhou: "+(e?.message||e),"err"); }
    };
  </script>
</body>
</html>
